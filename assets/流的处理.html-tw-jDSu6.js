import{_ as s,c as a,a as e,o as p}from"./app-UmXydJji.js";const t={};function c(o,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h1 id="å¯¹åŸºç¡€-sse-ä¸­æµçš„å¤„ç†çš„è§£è¯»" tabindex="-1"><a class="header-anchor" href="#å¯¹åŸºç¡€-sse-ä¸­æµçš„å¤„ç†çš„è§£è¯»"><span>å¯¹åŸºç¡€ SSE ä¸­æµçš„å¤„ç†çš„è§£è¯»</span></a></h1><h2 id="è§£æ" tabindex="-1"><a class="header-anchor" href="#è§£æ"><span>è§£æ</span></a></h2><p>è¿™æ˜¯ä¸€æ®µå®ç°å‰ç«¯æµå¼æ¥æ”¶å’Œå¤„ç† SSEï¼ˆServer-Sent Eventsï¼‰æ•°æ®çš„ä»£ç ï¼Œå®ƒæ²¡æœ‰ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„<code>EventSource</code>ï¼Œè€Œæ˜¯é‡‡ç”¨<code>fetch</code>é…åˆæµå¼è¯»å–æ¥è·å–å¹¶å¤„ç†æ•°æ®ï¼Œä»è€Œå®ç°äº†é€å­—è¾“å‡ºçš„æ•ˆæœã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€éƒ¨åˆ†è§£æã€‚</p><p>ğŸŒŸ æ³¨æ„æ ¸å¿ƒæ˜¯åœ¨<code>processStream</code>å‡½æ•°å†…éƒ¨ï¼Œå½“å¤„ç†å®Œä¸€ä¸ªæ•°æ®å—åï¼Œå®ƒå†æ¬¡è°ƒç”¨<code>reader.read().then(processStream)</code>ï¼Œä»è€Œå½¢æˆä¸€ä¸ªé€’å½’è°ƒç”¨é“¾ï¼Œç›´åˆ°æµç»“æŸï¼ˆ<code>done</code>ä¸º<code>true</code>ï¼‰</p><h3 id="ğŸ-å‡½æ•°å®šä¹‰ä¸åˆå§‹è®¾ç½®" tabindex="-1"><a class="header-anchor" href="#ğŸ-å‡½æ•°å®šä¹‰ä¸åˆå§‹è®¾ç½®"><span>ğŸ å‡½æ•°å®šä¹‰ä¸åˆå§‹è®¾ç½®</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">startStream</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isStreaming<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    outputText<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>const startStream = async () =&gt; {</code>ï¼šå®šä¹‰ä¸€ä¸ªåä¸º<code>startStream</code>çš„å¼‚æ­¥ç®­å¤´å‡½æ•°ï¼Œå› ä¸ºå®ƒå†…éƒ¨ä½¿ç”¨äº†<code>await</code>ã€‚</li><li><code>if (isStreaming.value) return;</code>ï¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨æµå¼ä¼ è¾“ä¸­ï¼ˆ<code>isStreaming</code>å¯èƒ½æ˜¯ä¸€ä¸ª Vue çš„ ref å“åº”å¼å˜é‡ï¼‰ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›ï¼Œé˜²æ­¢é‡å¤è¯·æ±‚ã€‚</li><li><code>outputText.value = &#39;&#39;;</code>ï¼šæ¸…ç©ºæ˜¾ç¤ºæ–‡æœ¬çš„å“åº”å¼å˜é‡ï¼Œå‡†å¤‡æ¥æ”¶æ–°æ•°æ®ã€‚</li><li><code>isStreaming.value = true;</code>ï¼šå°†æµå¼ä¼ è¾“çŠ¶æ€è®¾ç½®ä¸º<code>true</code>ï¼Œè¡¨ç¤ºè¯·æ±‚å·²å¼€å§‹ã€‚</li></ul><h3 id="ğŸŒ-å‘èµ·è¯·æ±‚ä¸è·å–æ•°æ®æµ" tabindex="-1"><a class="header-anchor" href="#ğŸŒ-å‘èµ·è¯·æ±‚ä¸è·å–æ•°æ®æµ"><span>ğŸŒ å‘èµ·è¯·æ±‚ä¸è·å–æ•°æ®æµ</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:3000/stream-text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok <span class="token operator">||</span> <span class="token operator">!</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;æµè¯·æ±‚å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> reader <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>const response = await fetch(&#39;http://localhost:3000/stream-text&#39;);</code>ï¼šä½¿ç”¨<code>fetch</code>API å‘èµ·ä¸€ä¸ª GET è¯·æ±‚åˆ°æŒ‡å®šçš„ SSE ç«¯ç‚¹ã€‚<code>await</code>ä¼šç­‰å¾…ç›´åˆ°æ¥æ”¶åˆ°æœåŠ¡å™¨çš„å“åº”å¤´ã€‚</li><li><code>if (!response.ok || !response.body) { ... }</code>ï¼šæ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸï¼ˆçŠ¶æ€ç  200-299ï¼‰ä»¥åŠå“åº”ä½“ï¼ˆ<code>body</code>ï¼‰æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä»»ä¸€æ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ã€‚</li><li><code>const reader = response.body.getReader();</code>ï¼šä»å“åº”ä½“ä¸­è·å–ä¸€ä¸ª<strong>å¯è¯»æµè¯»å–å™¨</strong>ï¼ˆ<code>ReadableStreamDefaultReader</code>ï¼‰ã€‚è¿™ä¸ªè¯»å–å™¨å…è®¸ä½ é€æ­¥è¯»å–å“åº”ä½“ä¸­çš„æ•°æ®å—ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨å†…å®¹ã€‚è°ƒç”¨<code>getReader()</code>æ–¹æ³•ä¼š<strong>é”å®š</strong>è¿™ä¸ªæµï¼Œä½¿å…¶ä¸èƒ½è¢«å…¶ä»–è¯»å–å™¨ä½¿ç”¨ã€‚</li><li><code>const decoder = new TextDecoder();</code>ï¼šåˆ›å»ºä¸€ä¸ª<code>TextDecoder</code>å¯¹è±¡ï¼Œç”¨äºå°†æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ•°æ®å—ï¼ˆé€šå¸¸æ˜¯<code>Uint8Array</code>ï¼‰è§£ç æˆå­—ç¬¦ä¸²ã€‚å®ƒé»˜è®¤ä½¿ç”¨ UTF-8 ç¼–ç ã€‚</li></ul><h3 id="ğŸ”„-å¤„ç†æ•°æ®æµçš„æ ¸å¿ƒè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-å¤„ç†æ•°æ®æµçš„æ ¸å¿ƒè¿‡ç¨‹"><span>ğŸ”„ å¤„ç†æ•°æ®æµçš„æ ¸å¿ƒè¿‡ç¨‹</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">processStream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> chunk <span class="token operator">=</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">stream</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> lines <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>const processStream = ({ done, value }) =&gt; { ... }</code>ï¼šå®šä¹‰äº†ä¸€ä¸ªå¤„ç†æ•°æ®å—çš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå¯¹è±¡å‚æ•°ï¼Œè¯¥å¯¹è±¡åŒ…å«<code>done</code>å’Œ<code>value</code>ä¸¤ä¸ªå±æ€§ã€‚ <code>done</code>ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæµæ˜¯å¦å·²ç»å…¨éƒ¨è¯»å–å®Œæ¯•ã€‚ <code>value</code>ï¼šä¸€ä¸ª<code>Uint8Array</code>ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®å—ï¼Œæ˜¯æœ¬æ¬¡è¯»å–åˆ°çš„å†…å®¹ã€‚</li><li><code>if (done) { ... }</code>ï¼šå¦‚æœæµå·²ç»“æŸï¼Œåˆ™æ›´æ–°çŠ¶æ€å¹¶é€€å‡ºå‡½æ•°ã€‚</li><li><code>const chunk = decoder.decode(value, { stream: true });</code>ï¼šä½¿ç”¨<code>TextDecoder</code>çš„<code>decode</code>æ–¹æ³•å°†äºŒè¿›åˆ¶æ•°æ®å—è§£ç æˆå­—ç¬¦ä¸²ã€‚<strong>å…³é”®ç‚¹åœ¨äº<code>{ stream: true }</code>è¿™ä¸ªé€‰é¡¹</strong>ï¼šå®ƒå‘Šè¯‰è§£ç å™¨æ•°æ®æ˜¯åˆ†å—ä¼ è¾“çš„ï¼Œå¯èƒ½åŒ…å«ä¸å®Œæ•´çš„å­—ç¬¦ï¼ˆæ¯”å¦‚å¤šå­—èŠ‚å­—ç¬¦å¦‚ä¸­æ–‡è¢«åˆ†å‰²åœ¨ä¸åŒçš„æ•°æ®å—ä¸­ï¼‰ï¼Œè§£ç å™¨ä¼šä¿ç•™è¿™äº›ä¸å®Œæ•´çš„å­—èŠ‚åºåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡<code>decode</code>è°ƒç”¨æ—¶å†ç»„åˆæˆå®Œæ•´çš„å­—ç¬¦ï¼Œä»è€Œé¿å…ä¹±ç ã€‚</li><li><code>const lines = chunk.split(&#39;\\n&#39;);</code>ï¼šSSE åè®®ä¸­ï¼Œæ¯æ¡æ¶ˆæ¯ä»¥æ¢è¡Œç¬¦åˆ†éš”ã€‚è¿™é‡Œå°†è§£ç åçš„å­—ç¬¦ä¸²æŒ‰è¡Œåˆ†å‰²ï¼Œä¾¿äºé€è¡Œå¤„ç†ã€‚</li></ul><h3 id="ğŸ“¨-è§£æ-sse-æ¶ˆæ¯æ ¼å¼" tabindex="-1"><a class="header-anchor" href="#ğŸ“¨-è§£æ-sse-æ¶ˆæ¯æ ¼å¼"><span>ğŸ“¨ è§£æ SSE æ¶ˆæ¯æ ¼å¼</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> line <span class="token keyword">of</span> lines<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;data: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token operator">...</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;è§£ææ¶ˆæ¯é”™è¯¯:&#39;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>if (line.startsWith(&#39;data: &#39;))</code>ï¼šæ£€æŸ¥ä¸€è¡Œæ˜¯å¦ä»¥<code>&quot;data: &quot;</code>å¼€å¤´ã€‚è¿™æ˜¯ SSE åè®®è§„å®šçš„<strong>æ•°æ®è¡Œæ ¼å¼</strong>ï¼Œæœ‰æ•ˆæ•°æ®ç´§è·Ÿå…¶åã€‚</li><li><code>const data = JSON.parse(line.substring(6));</code>ï¼šæå–<code>&quot;data: &quot;</code>ä¹‹åçš„å†…å®¹ï¼ˆ<code>line.substring(6)</code>ï¼‰ï¼Œå¹¶å°†å…¶ä½œä¸º JSON å­—ç¬¦ä¸²è§£ææˆ JavaScript å¯¹è±¡ã€‚ä½ çš„ç¤ºä¾‹ä¸­ï¼ŒæœåŠ¡å™¨å‘é€çš„æ•°æ®ç»“æ„å¯èƒ½åŒ…å«<code>char</code>ï¼ˆå­—ç¬¦ï¼‰ã€<code>done</code>ï¼ˆç»“æŸæ ‡å¿—ï¼‰ç­‰å­—æ®µã€‚</li></ul><h3 id="âœ¨-æ›´æ–°ç•Œé¢ä¸é€’å½’è¯»å–" tabindex="-1"><a class="header-anchor" href="#âœ¨-æ›´æ–°ç•Œé¢ä¸é€’å½’è¯»å–"><span>âœ¨ æ›´æ–°ç•Œé¢ä¸é€’å½’è¯»å–</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>char <span class="token operator">===</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  outputText<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  outputText<span class="token punctuation">.</span>value <span class="token operator">+=</span> data<span class="token punctuation">.</span>char<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>outputElement<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    outputElement<span class="token punctuation">.</span>value<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> outputElement<span class="token punctuation">.</span>value<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ ¹æ®è§£æåçš„<code>data</code>å¯¹è±¡æ›´æ–°ç•Œé¢ï¼š å¦‚æœ<code>data.done</code>ä¸º<code>true</code>ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å‘é€å®Œæ¯•ï¼Œæ›´æ–°çŠ¶æ€å¹¶è¿”å›ã€‚ æ ¹æ®<code>data.char</code>æ˜¯æ¢è¡Œç¬¦è¿˜æ˜¯æ™®é€šå­—ç¬¦ï¼Œå°†å…¶è¿½åŠ åˆ°æ˜¾ç¤ºæ–‡æœ¬<code>outputText.value</code>ä¸­ï¼Œå®ç°<strong>é€å­—è¾“å‡º</strong>çš„æ•ˆæœã€‚</li><li><code>nextTick(() =&gt; { ... });</code>ï¼šåœ¨ DOM æ›´æ–°åï¼Œå°†æ˜¾ç¤ºåŒºåŸŸçš„æ»šåŠ¨æ¡æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æœ€æ–°å†…å®¹å¯è§ã€‚<code>nextTick</code>æ˜¯ Vue.js æä¾›çš„æ–¹æ³•ã€‚</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">return</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>processStream<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>processStream<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>reader.read().then(processStream);</code>ï¼šè¿™æ˜¯å®ç°<strong>æµå¼è¯»å–çš„æ ¸å¿ƒå¾ªç¯</strong>ã€‚ <code>reader.read()</code>æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œå…¶è§£æå€¼å°±æ˜¯åŒ…å«<code>done</code>å’Œ<code>value</code>çš„å¯¹è±¡ã€‚ åœ¨<code>processStream</code>å‡½æ•°å†…éƒ¨ï¼Œå½“å¤„ç†å®Œä¸€ä¸ªæ•°æ®å—åï¼Œå®ƒå†æ¬¡è°ƒç”¨<code>reader.read().then(processStream)</code>ï¼Œä»è€Œå½¢æˆä¸€ä¸ªé€’å½’è°ƒç”¨é“¾ï¼Œç›´åˆ°æµç»“æŸï¼ˆ<code>done</code>ä¸º<code>true</code>ï¼‰ã€‚è¿™ç§æ–¹å¼ç¡®ä¿æ•°æ®ä¸€æ¥å°±å¤„ç†ï¼Œå®ç°äº†çœŸæ­£çš„æµå¼æ¥æ”¶ã€‚</li></ul><h3 id="ğŸ›¡ï¸-é”™è¯¯å¤„ç†" tabindex="-1"><a class="header-anchor" href="#ğŸ›¡ï¸-é”™è¯¯å¤„ç†"><span>ğŸ›¡ï¸ é”™è¯¯å¤„ç†</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;æµå¼è¯·æ±‚é”™è¯¯:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä½¿ç”¨<code>try...catch</code>æ•è·æ•´ä¸ªæµå¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ï¼ˆå¦‚ç½‘ç»œé”™è¯¯ã€è§£æé”™è¯¯ç­‰ï¼‰ï¼Œåœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå¹¶ç¡®ä¿å°†æµå¼ä¼ è¾“çŠ¶æ€<code>isStreaming.value</code>é‡ç½®ä¸º<code>false</code>ã€‚</li></ul><h3 id="ğŸ’-æ ¸å¿ƒæœºåˆ¶æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ’-æ ¸å¿ƒæœºåˆ¶æ€»ç»“"><span>ğŸ’ æ ¸å¿ƒæœºåˆ¶æ€»ç»“</span></a></h3><p>è¿™æ®µä»£ç çš„å…³é”®åœ¨äº<strong>ä½¿ç”¨<code>fetch</code>çš„æµå¼ API é€æ­¥è¯»å–å’Œå¤„ç† SSE æ•°æ®</strong>ï¼Œè€Œéä¸€æ¬¡æ€§åŠ è½½ã€‚å®ƒé€šè¿‡<code>getReader()</code>è·å–æ•°æ®æµè¯»å–å™¨ï¼Œå¾ªç¯è°ƒç”¨<code>read()</code>æ–¹æ³•è¯»å–æ•°æ®å—ï¼Œç”¨<code>TextDecoder</code>è§£ç ï¼ˆæ³¨æ„<code>{ stream: true }</code>é€‰é¡¹ï¼‰ï¼Œå¹¶æŒ‰ç…§ SSE åè®®è§£ææ•°æ®è¡Œï¼Œæœ€ç»ˆå®ç°é€å­—æ›´æ–°çš„è§†è§‰æ•ˆæœã€‚</p><p>å¸Œæœ›è¿™ä¸ªè¯¦ç»†çš„è§£é‡Šèƒ½å¸®åŠ©ä½ ç†è§£è¿™æ®µä»£ç çš„è¿ä½œæœºåˆ¶ï¼</p><h2 id="å®Œæ•´ä»£ç " tabindex="-1"><a class="header-anchor" href="#å®Œæ•´ä»£ç "><span>å®Œæ•´ä»£ç </span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">startStream</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isStreaming<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    outputText<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:3000/stream-text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok <span class="token operator">||</span> <span class="token operator">!</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;æµè¯·æ±‚å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//å°†ä¼ æ¥ çš„äºŒè¿›åˆ¶æ•°æ®æµè½¬æ¢ä¸ºæ–‡æœ¬</span></span>
<span class="line">    <span class="token keyword">const</span> reader <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> <span class="token function-variable function">processStream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> done<span class="token punctuation">,</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> chunk <span class="token operator">=</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">stream</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> lines <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> line <span class="token keyword">of</span> lines<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;data: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>char <span class="token operator">===</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              outputText<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">              outputText<span class="token punctuation">.</span>value <span class="token operator">+=</span> data<span class="token punctuation">.</span>char<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨</span></span>
<span class="line">            <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">if</span> <span class="token punctuation">(</span>outputElement<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                outputElement<span class="token punctuation">.</span>value<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span></span>
<span class="line">                  outputElement<span class="token punctuation">.</span>value<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;è§£ææ¶ˆæ¯é”™è¯¯:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">return</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>processStream<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>processStream<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;æµå¼è¯·æ±‚é”™è¯¯:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    isStreaming<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,29)])])}const i=s(t,[["render",c]]),u=JSON.parse('{"path":"/posts/sse/%E6%B5%81%E7%9A%84%E5%A4%84%E7%90%86.html","title":"å¯¹åŸºç¡€ SSE ä¸­æµçš„å¤„ç†çš„è§£è¯»","lang":"zh-CN","frontmatter":{"date":"2025-11-26T00:00:00.000Z","category":["ä»£ç è§£è¯»"],"tag":["SSE","fetchApi"]},"headers":[{"level":2,"title":"è§£æ","slug":"è§£æ","link":"#è§£æ","children":[{"level":3,"title":"ğŸ å‡½æ•°å®šä¹‰ä¸åˆå§‹è®¾ç½®","slug":"ğŸ-å‡½æ•°å®šä¹‰ä¸åˆå§‹è®¾ç½®","link":"#ğŸ-å‡½æ•°å®šä¹‰ä¸åˆå§‹è®¾ç½®","children":[]},{"level":3,"title":"ğŸŒ å‘èµ·è¯·æ±‚ä¸è·å–æ•°æ®æµ","slug":"ğŸŒ-å‘èµ·è¯·æ±‚ä¸è·å–æ•°æ®æµ","link":"#ğŸŒ-å‘èµ·è¯·æ±‚ä¸è·å–æ•°æ®æµ","children":[]},{"level":3,"title":"ğŸ”„ å¤„ç†æ•°æ®æµçš„æ ¸å¿ƒè¿‡ç¨‹","slug":"ğŸ”„-å¤„ç†æ•°æ®æµçš„æ ¸å¿ƒè¿‡ç¨‹","link":"#ğŸ”„-å¤„ç†æ•°æ®æµçš„æ ¸å¿ƒè¿‡ç¨‹","children":[]},{"level":3,"title":"ğŸ“¨ è§£æ SSE æ¶ˆæ¯æ ¼å¼","slug":"ğŸ“¨-è§£æ-sse-æ¶ˆæ¯æ ¼å¼","link":"#ğŸ“¨-è§£æ-sse-æ¶ˆæ¯æ ¼å¼","children":[]},{"level":3,"title":"âœ¨ æ›´æ–°ç•Œé¢ä¸é€’å½’è¯»å–","slug":"âœ¨-æ›´æ–°ç•Œé¢ä¸é€’å½’è¯»å–","link":"#âœ¨-æ›´æ–°ç•Œé¢ä¸é€’å½’è¯»å–","children":[]},{"level":3,"title":"ğŸ›¡ï¸ é”™è¯¯å¤„ç†","slug":"ğŸ›¡ï¸-é”™è¯¯å¤„ç†","link":"#ğŸ›¡ï¸-é”™è¯¯å¤„ç†","children":[]},{"level":3,"title":"ğŸ’ æ ¸å¿ƒæœºåˆ¶æ€»ç»“","slug":"ğŸ’-æ ¸å¿ƒæœºåˆ¶æ€»ç»“","link":"#ğŸ’-æ ¸å¿ƒæœºåˆ¶æ€»ç»“","children":[]}]},{"level":2,"title":"å®Œæ•´ä»£ç ","slug":"å®Œæ•´ä»£ç ","link":"#å®Œæ•´ä»£ç ","children":[]}],"git":{"updatedTime":1765244359000,"contributors":[{"name":"ksldnasx","username":"ksldnasx","email":"wh8261408@126.com","commits":4,"url":"https://github.com/ksldnasx"}],"changelog":[{"hash":"a0089923dda5b0a1e568fce8d29533128e78ce23","time":1765244359000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:å„ç±»æ–‡ä»¶å¸ƒå±€"},{"hash":"d9d7cdf943cd72ac0e02f5dfd986a904f9e0eee7","time":1764323248000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat:å®ä¹ å‘¨æ€»ç»“4"},{"hash":"62952a15f28ebf90d81fa23654b6a5d5c4285e78","time":1764240090000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:åˆ†ç±»ä¿®æ­£ï¼Œæ ‡é¢˜ä¿®æ”¹"},{"hash":"1bf4d21ff2fc9192ba869a7769c179396f8bcad0","time":1764215677000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat: sseå­¦ä¹ ä»¥åŠBoradcastChannel"}]},"filePathRelative":"posts/sse/æµçš„å¤„ç†.md","excerpt":"\\n<h2>è§£æ</h2>\\n<p>è¿™æ˜¯ä¸€æ®µå®ç°å‰ç«¯æµå¼æ¥æ”¶å’Œå¤„ç† SSEï¼ˆServer-Sent Eventsï¼‰æ•°æ®çš„ä»£ç ï¼Œå®ƒæ²¡æœ‰ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„<code>EventSource</code>ï¼Œè€Œæ˜¯é‡‡ç”¨<code>fetch</code>é…åˆæµå¼è¯»å–æ¥è·å–å¹¶å¤„ç†æ•°æ®ï¼Œä»è€Œå®ç°äº†é€å­—è¾“å‡ºçš„æ•ˆæœã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€éƒ¨åˆ†è§£æã€‚</p>\\n<p>ğŸŒŸ æ³¨æ„æ ¸å¿ƒæ˜¯åœ¨<code>processStream</code>å‡½æ•°å†…éƒ¨ï¼Œå½“å¤„ç†å®Œä¸€ä¸ªæ•°æ®å—åï¼Œå®ƒå†æ¬¡è°ƒç”¨<code>reader.read().then(processStream)</code>ï¼Œä»è€Œå½¢æˆä¸€ä¸ªé€’å½’è°ƒç”¨é“¾ï¼Œç›´åˆ°æµç»“æŸï¼ˆ<code>done</code>ä¸º<code>true</code>ï¼‰</p>"}');export{i as comp,u as data};
