import{_ as o,c,d as s,a as l,f as a,g as t,w as e,h as i,o as u}from"./app-UmXydJji.js";const r={};function k(d,n){const p=i("RouteLink");return u(),c("div",null,[n[6]||(n[6]=s("h1",{id:"sseservice文件解读-broadcastchannel版",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#sseservice文件解读-broadcastchannel版"},[s("span",null,"sseService文件解读(BroadcastChannel版)")])],-1)),s("p",null,[n[1]||(n[1]=a("源文件地址：",-1)),t(p,{to:"/posts/codes/sseServiceWithBroadcastChannel.html"},{default:e(()=>[...n[0]||(n[0]=[a("sseServiceWithBroadcastChannel.js",-1)])]),_:1})]),s("p",null,[n[3]||(n[3]=a("相关文章：",-1)),t(p,{to:"/posts/sse/BroadcastChannel%E6%96%B9%E5%BC%8F%E8%A7%A3%E5%86%B3sse%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html"},{default:e(()=>[...n[2]||(n[2]=[a("BroadcastChannel方式解决sse连接数限制",-1)])]),_:1})]),s("p",null,[n[5]||(n[5]=a("代码核心设计解读：",-1)),t(p,{to:"/posts/sse/BroadcastChannel%E6%96%B9%E5%BC%8F%E8%A7%A3%E5%86%B3sse%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html#%E6%A0%B8%E5%BF%83%E8%AE%BE%E8%AE%A1"},{default:e(()=>[...n[4]||(n[4]=[a("BroadcastChannel核心设计",-1)])]),_:1})]),n[7]||(n[7]=l(`<p>当然，为了深入了解这个 SSE 服务类的完整工作原理和代码逻辑。下面我会分模块、按流程进行细致解析。</p><h3 id="一、整体架构与核心目标" tabindex="-1"><a class="header-anchor" href="#一、整体架构与核心目标"><span>一、整体架构与核心目标</span></a></h3><p>这个<code>SSEService</code>类实现了一个<strong>支持多标签页共享的 Server-Sent Events 客户端</strong>，核心目标是：</p><ol><li>突破浏览器对单个域名的 SSE 连接限制（通常为 6 个）</li><li>仅让一个标签页（主标签页）建立实际 SSE 连接，其他标签页通过<code>BroadcastChannel</code>共享数据</li><li>主标签页失效时自动选举新主，保证服务不中断</li><li>对外提供统一接口，屏蔽内部复杂逻辑</li></ol><h3 id="二、核心模块解析" tabindex="-1"><a class="header-anchor" href="#二、核心模块解析"><span>二、核心模块解析</span></a></h3><h4 id="_1-类初始化-constructor" tabindex="-1"><a class="header-anchor" href="#_1-类初始化-constructor"><span>1. 类初始化（constructor）</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 1. 禁用开关：通过环境变量控制SSE服务是否启用</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VITE_SSE_DISABLED</span> <span class="token operator">===</span> <span class="token string">&#39;true&#39;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disabled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 初始化模拟对象，直接返回 */</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 2. 主从模式核心属性</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>isMaster <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 是否为主标签页</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 按顺序生成的标签页ID（tab-1, tab-2...）</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">&#39;sse-broadcast-channel&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 跨标签通信通道</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>masterKey <span class="token operator">=</span> <span class="token string">&#39;sse-master-instance-id&#39;</span> <span class="token comment">// localStorage中存储主标签页ID的键名</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>electionInProgress <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 选举锁，防止并发选举冲突</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 3. SSE连接属性</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// SSE连接实例</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 重连次数</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>maxReconnectAttempts <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">// 最大重连次数</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectInterval <span class="token operator">=</span> <span class="token number">3000</span> <span class="token comment">// 基础重连间隔</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>isConnected <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 连接状态</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 连接中状态</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>referenceCount <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 引用计数（防止重复连接/提前断开）</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 4. SSE服务配置</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl <span class="token operator">=</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VITE_SSE_BASE_URL</span> <span class="token operator">||</span> <span class="token string">&#39;http://localhost:8081&#39;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>sseEndpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/device/notifications/sse</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 5. 初始化工作流</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initMasterSlaveMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 初始化主从模式</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupPageUnloadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 页面卸载处理</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startConnectionMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 连接状态监控</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupTabCloseMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 标签页关闭监控</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>关键点</strong>：</p><ul><li>通过环境变量<code>VITE_SSE_DISABLED</code>提供灵活的开关控制是否开启SSE功能</li><li>所有核心属性在初始化时声明，保证状态可追踪</li><li>初始化流程按依赖顺序执行（先主从模式，再生命周期管理）</li></ul><h4 id="_2-标签页-id-生成-generateinstanceid" tabindex="-1"><a class="header-anchor" href="#_2-标签页-id-生成-generateinstanceid"><span>2. 标签页 ID 生成（generateInstanceId）</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">generateInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 从localStorage获取当前标签页计数（初始为0）</span></span>
<span class="line">    <span class="token keyword">let</span> tabCount <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tabCountKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;0&#39;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">    tabCount <span class="token operator">+=</span> <span class="token number">1</span> <span class="token comment">// 新标签页计数+1</span></span>
<span class="line">    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tabCountKey<span class="token punctuation">,</span> tabCount<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 保存新计数</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">tab-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tabCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span> <span class="token comment">// 返回直观ID（tab-1, tab-2...）</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 降级方案：localStorage不可用时使用时间戳+随机数</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">tab-fallback-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>设计思路</strong>：</p><ul><li>通过<code>localStorage</code>全局计数，保证 ID 严格按打开顺序生成</li><li>ID 格式直观（<code>tab-N</code>），一眼就能识别标签页打开顺序</li><li>有异常降级方案，保证鲁棒性</li></ul><h4 id="_3-主从模式管理-核心机制" tabindex="-1"><a class="header-anchor" href="#_3-主从模式管理-核心机制"><span>3. 主从模式管理（核心机制）</span></a></h4><h5 id="_3-1-初始化主从模式-initmasterslavemode" tabindex="-1"><a class="header-anchor" href="#_3-1-初始化主从模式-initmasterslavemode"><span>3.1 初始化主从模式（initMasterSlaveMode）</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">initMasterSlaveMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 1. 监听跨标签通信消息</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> data<span class="token punctuation">,</span> instanceId <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 忽略自己发的消息</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;master-announcement&#39;</span><span class="token operator">:</span> <span class="token comment">// 主标签页宣告</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isMaster <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 其他标签页收到宣告后放弃主身份</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;sse-message&#39;</span><span class="token operator">:</span> <span class="token comment">// SSE消息广播</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>eventType<span class="token punctuation">,</span> data<span class="token punctuation">.</span>payload<span class="token punctuation">)</span> <span class="token comment">// 触发本地事件</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;master-disconnected&#39;</span><span class="token operator">:</span> <span class="token comment">// 主标签页断开</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 触发重新选举</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;tab-closed&#39;</span><span class="token operator">:</span> <span class="token comment">// 标签页关闭</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>instanceId <span class="token operator">===</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 主标签页关闭则重新选举</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 2. 监听localStorage变化（跨标签同步主标签页状态）</span></span>
<span class="line">  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;storage&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newMasterId <span class="token operator">=</span> event<span class="token punctuation">.</span>newValue</span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newMasterId <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 主标签页标识被清除则选举</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newMasterId <span class="token operator">&amp;&amp;</span> newMasterId <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isMaster <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 新主产生则放弃主身份</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 3. 启动首次选举</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>核心逻辑</strong>：</p><ul><li>通过<code>BroadcastChannel</code>实现实时跨标签通信</li><li>通过<code>storage</code>事件监听<code>localStorage</code>变化，保证主标签页状态同步</li><li>不同消息类型对应不同处理逻辑，形成完整的主从协同机制</li></ul><h5 id="_3-2-主标签页选举-electionmaster" tabindex="-1"><a class="header-anchor" href="#_3-2-主标签页选举-electionmaster"><span>3.2 主标签页选举（electionMaster）</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>electionInProgress<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 选举锁：防止并发冲突</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>electionInProgress <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 延迟1秒：让所有标签页都有机会参与选举，避免抢锁</span></span>
<span class="line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> currentMasterId <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentMasterId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 无主则当前标签页当选</span></span>
<span class="line">        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isMaster <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 向其他标签页宣告</span></span>
<span class="line">          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;master-announcement&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnected<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 当选后主标签页建立SSE连接</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 已有主则更新自身状态</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isMaster <span class="token operator">=</span> currentMasterId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId</span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>electionInProgress <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 释放选举锁</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>选举机制</strong>：</p><ul><li><strong>延迟选举</strong>：1 秒延迟确保所有标签页都能检测到当前主状态</li><li><strong>原子性保障</strong>：通过<code>localStorage</code>的原子操作避免 &quot;多主&quot; 问题</li><li><strong>宣告机制</strong>：新主产生后主动宣告，其他标签页立即更新状态</li></ul><h4 id="_4-sse-连接管理" tabindex="-1"><a class="header-anchor" href="#_4-sse-连接管理"><span>4. SSE 连接管理</span></a></h4><h5 id="_4-1-建立连接-connect" tabindex="-1"><a class="header-anchor" href="#_4-1-建立连接-connect"><span>4.1 建立连接（connect）</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disabled<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 禁用状态直接返回</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 从标签页不建立实际连接</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>referenceCount<span class="token operator">++</span> <span class="token comment">// 引用计数+1（防止重复连接）</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnected <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 已有连接则返回</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sseEndpoint<span class="token punctuation">)</span> <span class="token comment">// 建立SSE连接</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 连接超时处理（2分钟）</span></span>
<span class="line">    <span class="token keyword">const</span> connectionTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnected<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;SSE连接超时&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 连接成功事件</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;connected&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isConnected <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>connectionTimeout<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;connected&#39;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// 触发本地事件</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">broadcastSSEMessage</span><span class="token punctuation">(</span><span class="token string">&#39;connected&#39;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// 广播给其他标签页</span></span>
<span class="line">        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 各类业务事件监听（device-online/device-offline等）</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token comment">// 触发本地事件</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">broadcastSSEMessage</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token comment">// 广播给其他标签页</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 错误处理与重连</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isConnected <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line">        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token comment">// 触发重连</span></span>
<span class="line">        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;SSE连接已关闭&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>连接机制</strong>：</p><ul><li><strong>主标签页独占连接</strong>：只有主标签页会创建<code>EventSource</code>实例</li><li><strong>引用计数</strong>：防止多次调用<code>connect()</code>导致重复连接</li><li><strong>超时保护</strong>：2 分钟超时避免无限等待</li><li><strong>事件双向分发</strong>：主标签页收到 SSE 事件后，既触发本地事件，也广播给其他标签页</li></ul><h5 id="_4-2-重连逻辑-handlereconnect" tabindex="-1"><a class="header-anchor" href="#_4-2-重连逻辑-handlereconnect"><span>4.2 重连逻辑（handleReconnect）</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 非主/连接中则跳过</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxReconnectAttempts<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;max-reconnect-reached&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 达到最大重连次数触发事件</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts<span class="token operator">++</span></span>
<span class="line">  <span class="token keyword">const</span> baseDelay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reconnectInterval <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span> <span class="token comment">// 指数退避</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 关闭旧连接</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 重新连接</span></span>
<span class="line">      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> baseDelay<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重连策略</strong>：</p><ul><li><strong>指数退避</strong>：重连间隔按 2 的幂次增长（3s→6s→12s…），最大 30s</li><li><strong>重连次数限制</strong>：最多 5 次，避免无限重连</li><li><strong>主标签页限制</strong>：只有主标签页会执行重连</li></ul><h4 id="_5-跨标签消息广播-broadcastssemessage" tabindex="-1"><a class="header-anchor" href="#_5-跨标签消息广播-broadcastssemessage"><span>5. 跨标签消息广播（broadcastSSEMessage）</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">broadcastSSEMessage</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 只有主标签页能广播</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;sse-message&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> eventType<span class="token punctuation">,</span> payload <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>作用</strong>：主标签页将 SSE 事件转发给所有从标签页，实现数据共享</p><h4 id="_6-生命周期管理" tabindex="-1"><a class="header-anchor" href="#_6-生命周期管理"><span>6. 生命周期管理</span></a></h4><h5 id="_6-1-页面卸载处理-setuppageunloadhandler" tabindex="-1"><a class="header-anchor" href="#_6-1-页面卸载处理-setuppageunloadhandler"><span>6.1 页面卸载处理（setupPageUnloadHandler）</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">setupPageUnloadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 广播自己关闭的消息</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;tab-closed&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 如果是主标签页，清除主标识并通知重选</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;master-disconnected&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">const</span> currentMasterId <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMasterId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span> <span class="token comment">// 清除主标识</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 断开连接</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 关闭通信通道</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>关键处理</strong>：</p><ul><li>主标签页关闭时主动清除<code>localStorage</code>中的主标识</li><li>广播 &quot;主断开&quot; 消息，触发其他标签页重新选举</li><li>清理资源（断开连接、关闭通道）</li></ul><h5 id="_6-2-连接状态监控-startconnectionmonitor" tabindex="-1"><a class="header-anchor" href="#_6-2-连接状态监控-startconnectionmonitor"><span>6.2 连接状态监控（startConnectionMonitor）</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">startConnectionMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 主标签页检查连接状态</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">CLOSED</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 连接关闭则重连</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 从标签页检查主标签页是否存在</span></span>
<span class="line">      <span class="token keyword">const</span> currentMasterId <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentMasterId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 主不存在则选举</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">// 每10秒检查一次</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>监控机制</strong>：</p><ul><li>主标签页：检查自身 SSE 连接状态，异常则重连</li><li>从标签页：检查主标签页是否存活，无主则触发选举</li><li>高频检查（10 秒）：保证快速发现异常</li></ul><h3 id="三、完整工作流程" tabindex="-1"><a class="header-anchor" href="#三、完整工作流程"><span>三、完整工作流程</span></a></h3><h4 id="_1-新标签页打开时" tabindex="-1"><a class="header-anchor" href="#_1-新标签页打开时"><span>1. 新标签页打开时：</span></a></h4><ol><li><p>生成顺序 ID（如<code>tab-3</code>）</p></li><li><p>初始化<code>BroadcastChannel</code>并监听消息</p></li><li><p>检查 <code>localStorage</code> 中是否有主标签页</p><ul><li>无主：参与选举并当选，建立 SSE 连接</li><li>有主：成为从标签页，通过广播接收数据</li></ul></li></ol><h4 id="_2-主标签页正常工作时" tabindex="-1"><a class="header-anchor" href="#_2-主标签页正常工作时"><span>2. 主标签页正常工作时：</span></a></h4><ol><li>主标签页接收 SSE 事件，触发本地事件 + 广播给其他标签页</li><li>从标签页通过<code>BroadcastChannel</code>接收事件，触发本地事件</li><li>所有标签页对外表现一致的事件行为</li></ol><h4 id="_3-主标签页关闭-刷新时" tabindex="-1"><a class="header-anchor" href="#_3-主标签页关闭-刷新时"><span>3. 主标签页关闭 / 刷新时：</span></a></h4><ol><li>主标签页在卸载前广播 &quot;主断开&quot; 消息 + 清除主标识</li><li>从标签页收到消息 / 检测到主标识消失，触发重新选举</li><li>ID 最小的存活标签页当选新主，建立新的 SSE 连接</li><li>服务无缝切换，无感知中断</li></ol><h3 id="四、对外接口设计" tabindex="-1"><a class="header-anchor" href="#四、对外接口设计"><span>四、对外接口设计</span></a></h3><h4 id="_1-事件监听-移除" tabindex="-1"><a class="header-anchor" href="#_1-事件监听-移除"><span>1. 事件监听 / 移除</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 添加事件监听</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function">off</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 移除事件监听</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> index <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> callbacks<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-事件触发" tabindex="-1"><a class="header-anchor" href="#_2-事件触发"><span>2. 事件触发</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 触发本地事件</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// 执行回调</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">事件处理器执行错误 [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 错误隔离</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-状态查询" tabindex="-1"><a class="header-anchor" href="#_3-状态查询"><span>3. 状态查询</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">getConnectionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取当前连接状态</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">isMaster</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">isConnected</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isConnected<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceId<span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 其他状态...</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="五、主标签页超时检查逻辑" tabindex="-1"><a class="header-anchor" href="#五、主标签页超时检查逻辑"><span>五、主标签页超时检查逻辑</span></a></h3><p>这段代码是<strong>从标签页检测主标签页是否存活的核心逻辑</strong>，<code>refreshTimeout</code>作为心跳超时定时器，用于判断主标签页是否失效，进而触发重新选举。以下是具体逻辑解析：</p><h4 id="一、refreshtimeout的核心作用" tabindex="-1"><a class="header-anchor" href="#一、refreshtimeout的核心作用"><span>一、<code>refreshTimeout</code>的核心作用</span></a></h4><p><code>refreshTimeout</code>是一个定时器引用，用于监控主标签页的心跳响应。当从标签页发送<code>ping</code>消息后，如果在规定时间（5 秒）内未收到主标签页的<code>pong</code>响应，<code>refreshTimeout</code>会触发重新选举主标签页的逻辑，确保 SSE 连接始终由有效的主标签页维护。</p><h4 id="二、围绕refreshtimeout的完整逻辑流程" tabindex="-1"><a class="header-anchor" href="#二、围绕refreshtimeout的完整逻辑流程"><span>二、围绕<code>refreshTimeout</code>的完整逻辑流程</span></a></h4><p>代码位于<code>startActiveTabsMonitor</code>方法中，该方法每 30 秒执行一次（主标签页存活检查），具体流程如下：</p><h5 id="_1-触发时机-从标签页定期检查主标签页状态" tabindex="-1"><a class="header-anchor" href="#_1-触发时机-从标签页定期检查主标签页状态"><span>1. 触发时机：从标签页定期检查主标签页状态</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 每30秒检查一次主标签页状态（仅从标签页执行）</span></span>
<span class="line"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当前是从标签页</span></span>
<span class="line">    <span class="token keyword">const</span> currentMasterInstanceId <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentMasterInstanceId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 主标签页标识不存在，直接触发重新选举</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;检测到主标签页不存在，触发重新选举&#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 主标签页标识存在，发送ping消息检查其是否存活</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;ping&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">tabId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tabId<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">instanceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tabInstanceId</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// 关键逻辑：设置超时定时器refreshTimeout</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清除旧定时器（避免重复）</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 5秒内未收到pong响应，判定主标签页失效</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;主标签页心跳超时，触发重新选举&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新选举主标签页</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每30秒执行一次</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-核心逻辑拆解" tabindex="-1"><a class="header-anchor" href="#_2-核心逻辑拆解"><span>2. 核心逻辑拆解</span></a></h5><ul><li><strong>发送<code>ping</code>消息</strong>：从标签页每 30 秒向主标签页发送<code>ping</code>消息（类似 “心跳探测”），询问主标签页是否存活。</li><li><strong>设置<code>refreshTimeout</code>定时器</strong>：发送<code>ping</code>后，立即设置一个 5 秒的定时器<code>refreshTimeout</code>。这个定时器的作用是：如果 5 秒内没收到主标签页的<code>pong</code>响应，就认为主标签页已崩溃 / 关闭 / 失去响应。</li><li><strong>超时触发重新选举</strong>：若 5 秒内未收到<code>pong</code>，<code>refreshTimeout</code>的回调函数执行，调用<code>this.electionMaster()</code>重新选举新的主标签页，确保 SSE 连接不中断。</li><li><strong>避免重复定时器</strong>：每次设置新的<code>refreshTimeout</code>前，先通过<code>clearTimeout(this.refreshTimeout)</code>清除旧的定时器，防止多个定时器叠加导致误触发。</li></ul><h5 id="_3-本应存在的pong响应处理-原代码缺失" tabindex="-1"><a class="header-anchor" href="#_3-本应存在的pong响应处理-原代码缺失"><span>3. 本应存在的<code>pong</code>响应处理（原代码缺失）</span></a></h5><p>正常逻辑中，主标签页收到<code>ping</code>后会回复<code>pong</code>消息，从标签页应在收到<code>pong</code>时清除<code>refreshTimeout</code>，避免误判超时。因此原<code>broadcastChannel.onmessage</code>处应处理<code>pong</code>消息，使<code>refreshTimeout</code>在收到主标签页的心跳后能正常清除：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 在broadcastChannel.onmessage的switch中添加pong处理</span></span>
<span class="line"><span class="token keyword">case</span> <span class="token string">&#39;pong&#39;</span><span class="token operator">:</span></span>
<span class="line">  <span class="token comment">// 确认发送pong的是当前主标签页</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceId <span class="token operator">===</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>masterKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;收到主标签页pong响应，清除超时定时器&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清除超时定时器，避免误触发选举</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="三、总结" tabindex="-1"><a class="header-anchor" href="#三、总结"><span>三、总结</span></a></h4><p><code>refreshTimeout</code>是从标签页判断主标签页是否存活的 “超时判定器”，其逻辑设计的核心目的是：通过 “<code>ping</code>发送→<code>pong</code>等待→超时判定” 的流程，确保主标签页失效时能及时触发重新选举，维持 SSE 服务的连续性。（注：原代码因缺少<code>pong</code>处理导致<code>refreshTimeout</code>无法清除，会引发误判，需补充<code>pong</code>消息的处理逻辑。）</p><h3 id="六、标签页活跃状态监控" tabindex="-1"><a class="header-anchor" href="#六、标签页活跃状态监控"><span>六、标签页活跃状态监控</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">startActiveTabsMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 定期更新当前标签页的时间戳，标记为活跃</span></span>
<span class="line">    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> activeTabs <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span></span>
<span class="line">          localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeTabsKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;[]&quot;</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> tabIndex <span class="token operator">=</span> activeTabs<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span></span>
<span class="line">          <span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> tab<span class="token punctuation">.</span>instanceId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tabInstanceId</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>tabIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          activeTabs<span class="token punctuation">[</span>tabIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeTabsKey<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>activeTabs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">// 重新注册</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerActiveTab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;更新活跃标签页时间戳失败:&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码中 “定期更新当前标签页时间戳并标记为活跃” 的逻辑，是为了<strong>维持标签页的 “活跃状态”，确保主标签页选举机制能基于真实有效的标签页列表进行，避免因标签页 “假死” 或 “失效” 导致的选举异常</strong>。</p><h4 id="核心逻辑拆解" tabindex="-1"><a class="header-anchor" href="#核心逻辑拆解"><span>核心逻辑拆解</span></a></h4><h5 id="_1-为什么需要-标记活跃" tabindex="-1"><a class="header-anchor" href="#_1-为什么需要-标记活跃"><span>1. 为什么需要 “标记活跃”？</span></a></h5><p>在多标签页场景中，浏览器无法直接感知其他标签页是否仍在正常运行（可能被用户关闭、崩溃，或长时间未操作）。因此，代码通过<code>localStorage</code>维护了一个 “活跃标签页列表”（<code>activeTabsKey</code>对应的存储），每个标签页需要主动证明自己 “还活着”。</p><p>时间戳（<code>timestamp</code>）是标签页 “活跃度” 的凭证：<strong>时间戳越新，说明标签页越可能处于正常运行状态</strong>。</p><h5 id="_2-定时更新的具体作用" tabindex="-1"><a class="header-anchor" href="#_2-定时更新的具体作用"><span>2. 定时更新的具体作用</span></a></h5><p>代码通过<code>setInterval</code>每 60 秒（1 分钟）执行一次更新操作，核心目的是：</p><ul><li><p><strong>避免被判定为 “过期标签页”</strong>：代码中有一个<code>cleanExpiredTabs</code>方法，会定期清理 “5 分钟内未更新时间戳” 的标签页（认为这些标签页已失效）。当前标签页每 1 分钟更新一次时间戳，确保自己始终处于 “5 分钟有效期” 内，不会被清理。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 清理过期标签页的逻辑（5分钟未更新则视为过期）</span></span>
<span class="line"><span class="token function">cleanExpiredTabs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token constant">FIVE_MINUTES</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span></span>
<span class="line">  <span class="token keyword">const</span> validTabs <span class="token operator">=</span> activeTabs<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">tab</span> <span class="token operator">=&gt;</span> now <span class="token operator">-</span> tab<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> <span class="token constant">FIVE_MINUTES</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment">// ...保存有效标签页</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>确保主标签页选举的准确性</strong>：主标签页选举（<code>electionMaster</code>）的前提是 “基于活跃标签页列表”。如果当前标签页不更新时间戳，会被<code>cleanExpiredTabs</code>移除，导致：</p><ul><li>若当前标签页是主标签页：会被判定为失效，触发重新选举（错误地失去主标签页身份）；</li><li>若当前标签页是从标签页：会被排除在选举候选人之外，无法在主标签页失效时参与补选。</li></ul></li></ul><h5 id="_3-异常处理-重新注册" tabindex="-1"><a class="header-anchor" href="#_3-异常处理-重新注册"><span>3. 异常处理：重新注册</span></a></h5><p>如果在更新时发现当前标签页已不在活跃列表中（<code>tabIndex === -1</code>），会调用<code>this.registerActiveTab()</code>重新注册。这是为了应对极端情况：</p><ul><li>可能因<code>localStorage</code>数据意外丢失（如浏览器清理缓存），导致当前标签页的记录被删除；</li><li>重新注册能确保当前标签页重新加入活跃列表，避免 “明明在运行却被排除在外” 的问题。</li></ul><h4 id="小结" tabindex="-1"><a class="header-anchor" href="#小结"><span>小结</span></a></h4><p>定时更新时间戳的逻辑是多标签页协同的 “心跳维持机制”：通过主动刷新 “活跃度凭证”，确保当前标签页不会被系统误判为 “已失效”，从而保证主标签页选举基于真实有效的标签页列表，最终维持 SSE 服务的稳定运行（只有活跃的主标签页才会保持 SSE 连接）。</p><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h3><p>这个<code>SSEService</code>的核心设计亮点：</p><ol><li><strong>透明的主从模式</strong>：对外接口统一，业务层无需关心主从身份</li><li><strong>健壮的选举机制</strong>：通过<code>localStorage</code>+<code>BroadcastChannel</code>保证选举的原子性和实时性</li><li><strong>优雅的故障转移</strong>：主标签页失效时自动选举新主，服务不中断</li><li><strong>直观的 ID 设计</strong>：<code>tab-N</code>格式让标签页顺序一目了然</li><li><strong>完善的错误处理</strong>：超时、重连、异常捕获全覆盖</li></ol><p>整个类遵循 &quot;内部复杂，外部简单&quot; 的设计原则，将多标签协同的复杂性封装在内部，对外提供简洁一致的 API，让业务开发更高效。</p>`,91))])}const m=o(r,[["render",k]]),b=JSON.parse('{"path":"/posts/sse/BroadcastChannel%E7%89%88%E6%9C%ACsse%E8%A7%A3%E8%AF%BB.html","title":"sseService文件解读(BroadcastChannel版)","lang":"zh-CN","frontmatter":{"date":"2025-11-27T00:00:00.000Z","category":["代码解读"],"tag":["SSE","BroadcastChannel"]},"headers":[{"level":3,"title":"一、整体架构与核心目标","slug":"一、整体架构与核心目标","link":"#一、整体架构与核心目标","children":[]},{"level":3,"title":"二、核心模块解析","slug":"二、核心模块解析","link":"#二、核心模块解析","children":[]},{"level":3,"title":"三、完整工作流程","slug":"三、完整工作流程","link":"#三、完整工作流程","children":[]},{"level":3,"title":"四、对外接口设计","slug":"四、对外接口设计","link":"#四、对外接口设计","children":[]},{"level":3,"title":"五、主标签页超时检查逻辑","slug":"五、主标签页超时检查逻辑","link":"#五、主标签页超时检查逻辑","children":[]},{"level":3,"title":"六、标签页活跃状态监控","slug":"六、标签页活跃状态监控","link":"#六、标签页活跃状态监控","children":[]},{"level":3,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"updatedTime":1765271411000,"contributors":[{"name":"ksldnasx","username":"ksldnasx","email":"wh8261408@126.com","commits":7,"url":"https://github.com/ksldnasx"}],"changelog":[{"hash":"38f5d2d76c8dd864b56b327c069ef5bcfd035c0c","time":1765271411000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix: link change"},{"hash":"acd93ed23f26117dad056c26ee821ccbe6fb6c2e","time":1765250440000,"email":"wh8261408@126.com","author":"ksldnasx","message":"style:开始页样式大改 fix:链接正确修改"},{"hash":"a0089923dda5b0a1e568fce8d29533128e78ce23","time":1765244359000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:各类文件布局"},{"hash":"305509a2698c63f4713ace6497663dcf57d07dbd","time":1764640332000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:修改文章筛选条件，增加标题展示语句"},{"hash":"1e6f5a9933d7b094d5a4a3df91b6f285913bd880","time":1764324107000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:开始页面链接补全"},{"hash":"62952a15f28ebf90d81fa23654b6a5d5c4285e78","time":1764240090000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:分类修正，标题修改"},{"hash":"9be085721b208a8eed7c4344c669706800e0c95a","time":1764239888000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat:更新BroadcastChannel说明文档以及代码"}]},"filePathRelative":"posts/sse/BroadcastChannel版本sse解读.md","excerpt":"\\n<p>源文件地址：<a href=\\"/vuepress_blog/posts/codes/sseServiceWithBroadcastChannel.html\\" target=\\"_blank\\">sseServiceWithBroadcastChannel.js</a></p>\\n<p>相关文章：<a href=\\"/vuepress_blog/posts/sse/BroadcastChannel%E6%96%B9%E5%BC%8F%E8%A7%A3%E5%86%B3sse%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html\\" target=\\"_blank\\">BroadcastChannel方式解决sse连接数限制</a></p>"}');export{m as comp,b as data};
