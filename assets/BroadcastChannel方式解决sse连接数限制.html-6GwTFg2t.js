import{_ as c,c as l,a as i,d as t,f as s,g as e,w as p,h as u,o as r}from"./app-UmXydJji.js";const o="/vuepress_blog/assets/BroadcastChannel-C0PR7yXL.png",d={};function k(g,n){const a=u("RouteLink");return r(),l("div",null,[n[4]||(n[4]=i('<h1 id="sse最大连接次数突破" tabindex="-1"><a class="header-anchor" href="#sse最大连接次数突破"><span>SSE最大连接次数突破</span></a></h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>在我们建立sse连接的时候，由于<strong>HTTP/1.1</strong>的限制，在该协议下，大多数现代浏览器（如Chrome、Firefox、Edge）对<strong>同一域名（协议+域名+端口）的并发连接数限制通常为6个</strong>。这意味着，同一个浏览器标签页（或同一浏览器实例）中，对相同域名最多只能同时建立约6个SSE连接，超出此数量的新连接会被浏览器阻塞，直到有连接被关闭。</p><p>若需要突破此限制，可考虑以下方案：</p><table><thead><tr><th style="text-align:left;">解决方案</th><th style="text-align:left;">描述</th><th style="text-align:left;">适用场景</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>升级至HTTP/2</strong></td><td style="text-align:left;">HTTP/2支持<strong>多路复用</strong>，可在单个TCP连接上并行处理多个请求和响应，从而从根本上解决连接数限制问题。</td><td style="text-align:left;"><strong>长远和推荐方案</strong>，需服务器和浏览器支持，通常要求使用HTTPS。</td></tr><tr><td style="text-align:left;"><strong>多域名/多端口策略</strong></td><td style="text-align:left;">将SSE连接分散到不同的子域（如<code>sse1.example.com</code>, <code>sse2.example.com</code>）或不同端口号。每个子域或端口享有独立的6个连接限额。</td><td style="text-align:left;"><strong>过渡方案</strong>，适用于暂无法升级HTTP/2的情况，但配置管理稍复杂。</td></tr><tr><td style="text-align:left;"><strong>优化连接使用</strong></td><td style="text-align:left;">利用标签页切换及时关闭不再需要的SSE连接，或尝试将多个数据流合并到一个SSE连接中传输（通过不同事件类型区分）。</td><td style="text-align:left;"><strong>基础优化</strong>，良好的连接管理习惯。</td></tr></tbody></table><p>但是以上方法都存在一定缺陷，HTTP/2存在兼容性问题，多端口策略过于繁琐，动态切换策略又过于消耗资源。</p><p>然后自然想到的就是<strong>SharedWorker</strong>，他可以将多个标签页共享一个SSE连接，且 <strong>SharedWorker</strong>自动管理连接生命周期，但是存在的问题是后期调试特别复杂，同时其相当于一个中间层，会对业务代码进行改动，较为复杂。</p><p>最后根据学长的建议选择了<strong>BroadcastChannel</strong> 的主从模式这种解决方式，它在保证较为轻量级且兼容性更好的情况下，基本上避免了业务逻辑部分的代码的修改，只需要对SSE连接的代码的主体文件进行修改。</p><p><strong>BroadcastChannel</strong> 的主从模式类似一个频道，对于每个打开的标签页进行选举，选举好主标签页后主标签页建立SSE连接，同时对各类服务器更新的事件，利用<strong>BroadcastChannel</strong>进行广播，从标签页在收到广播后触发本地的处理器并更新数据。其核心就是让多个标签页共享一个SSE连接，避免连接数超限。</p><h3 id="核心思想" tabindex="-1"><a class="header-anchor" href="#核心思想"><span><strong>核心思想</strong></span></a></h3><ol><li><strong>只有一个&quot;主&quot;标签页</strong>真正建立SSE连接</li><li><strong>其他&quot;从&quot;标签页</strong>通过消息通道接收事件</li><li><strong>自动选举和故障转移</strong>确保高可用性</li></ol><p><img src="'+o+`" alt="BroadcastChannel主从模式消息传递演示"></p><h2 id="原理机制详解" tabindex="-1"><a class="header-anchor" href="#原理机制详解"><span>原理机制详解</span></a></h2><h3 id="_1-通信基础-broadcastchannel" tabindex="-1"><a class="header-anchor" href="#_1-通信基础-broadcastchannel"><span>1. 通信基础：BroadcastChannel</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 所有标签页创建相同的频道</span></span>
<span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">&#39;sse-connection&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 发送消息（所有同源标签页都能收到）</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">&#39;消息内容&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 接收消息</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;收到消息:&#39;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-主从选举机制" tabindex="-1"><a class="header-anchor" href="#_2-主从选举机制"><span>2. 主从选举机制</span></a></h3><p><strong>目标</strong>：在多个标签页中选出唯一的&quot;主&quot;</p><p><strong>选举流程</strong>：</p><ol><li><strong>宣布参选</strong>：每个标签页启动时都宣布自己要参与选举</li><li><strong>收集候选</strong>：等待一段时间收集所有参选的标签页</li><li><strong>确定主节点</strong>：按特定规则（如ID最小）选出主标签页</li><li><strong>公布结果</strong>：将选举结果广播给所有标签页</li></ol><h3 id="_3-消息广播机制" tabindex="-1"><a class="header-anchor" href="#_3-消息广播机制"><span>3. 消息广播机制</span></a></h3><p><strong>主标签页职责</strong>：</p><ul><li>建立唯一真实的SSE连接</li><li>接收服务器推送的事件</li><li>将事件广播给所有从标签页</li></ul><p><strong>从标签页职责</strong>：</p><ul><li>监听主标签页的广播消息</li><li>触发本地的事件处理器</li></ul><p><img src="`+o+`" alt="BroadcastChannel主从模式消息传递演示"></p><h3 id="_4-故障转移机制" tabindex="-1"><a class="header-anchor" href="#_4-故障转移机制"><span>4. 故障转移机制</span></a></h3><p><strong>心跳检测</strong>：</p><ul><li>主标签页定期发送心跳信号</li><li>从标签页监控心跳，发现超时则重新选举</li></ul><p><strong>主标签页异常处理</strong>：</p><ul><li>页面关闭前尝试转移控制权</li><li>崩溃时自动触发重新选举</li></ul><h2 id="需要改其他业务逻辑代码吗" tabindex="-1"><a class="header-anchor" href="#需要改其他业务逻辑代码吗"><span>需要改其他业务逻辑代码吗？</span></a></h2><p>并不需要，其他页面使用 <code>sseService</code> 的方式可以保持不变，主从模式的逻辑是在 <code>SSEService</code> 内部实现的，对外部使用层是透明的。</p><h3 id="具体使用方式-与之前兼容" tabindex="-1"><a class="header-anchor" href="#具体使用方式-与之前兼容"><span>具体使用方式（与之前兼容）</span></a></h3><p>你仍然可以通过以下方式在页面中使用 SSE 服务，无需关心当前是主标签页还是从标签页：</p><ol><li><strong>引入服务</strong>：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">import</span> sseService <span class="token keyword">from</span> <span class="token string">&#39;@/path/to/sseService.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li><strong>监听事件</strong>（如设备上线、离线等）：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 监听设备上线事件</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;设备上线:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 处理业务逻辑（如更新UI、提示用户等）</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 监听连接状态事件</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connected&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;SSE连接成功:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 监听错误事件</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;SSE错误:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>建立连接</strong>：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 调用connect()即可，内部会自动判断是否为主标签页（主标签页实际建立连接，从标签页通过BroadcastChannel接收事件）</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;连接请求已处理&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;连接处理失败:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>断开连接</strong>：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 调用disconnect()，内部会根据引用计数和主从状态判断是否实际断开连接</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li><strong>移除事件监听</strong>（避免内存泄漏）：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">handleDeviceOffline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;设备离线:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 添加监听</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> handleDeviceOffline<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 页面卸载或不需要时移除</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> handleDeviceOffline<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="核心原因" tabindex="-1"><a class="header-anchor" href="#核心原因"><span>核心原因</span></a></h3><p>主从模式通过 <code>BroadcastChannel</code> 和 <code>localStorage</code> 实现的是<strong>内部连接管理逻辑</strong>，对外暴露的 <code>on</code>/<code>off</code>/<code>connect</code>/<code>disconnect</code> 等接口并未改变。无论是主标签页（实际建立 SSE 连接）还是从标签页（通过广播接收事件），都会通过 <code>emit</code> 方法触发你注册的事件回调，因此业务层无需做任何调整。</p><h2 id="核心设计" tabindex="-1"><a class="header-anchor" href="#核心设计"><span>核心设计</span></a></h2><p>该代码实现了一个基于 Server-Sent Events (SSE) 的服务，核心设计围绕<strong>主从标签页模式</strong>展开，通过解决多标签页连接限制、确保连接稳定性、同步状态等问题，实现了高效的实时消息推送。以下是几个核心设计的详细说明：</p><h3 id="_1-主从标签页模式-突破-sse-连接限制" tabindex="-1"><a class="header-anchor" href="#_1-主从标签页模式-突破-sse-连接限制"><span>1. 主从标签页模式（突破 SSE 连接限制）</span></a></h3><p>浏览器对同一域名的并发连接数有限制（通常为 6 个），若多个标签页同时建立 SSE 连接，可能导致连接失败或阻塞。因此，代码设计了 “主从模式”：</p><ul><li><strong>主标签页</strong>：唯一与后端建立 SSE 连接的标签页，负责接收实时消息并广播给所有从标签页。</li><li><strong>从标签页</strong>：不直接连接 SSE，通过<code>BroadcastChannel</code>接收主标签页转发的消息。</li></ul><p><strong>核心实现</strong>：</p><ul><li>通过<code>electionMaster()</code>方法选举主标签页：按标签页 ID（<code>tab-1</code>、<code>tab-2</code>...）排序，ID 最小的标签页当选为主标签页。</li><li>主标签页通过<code>localStorage</code>存储自身标识（<code>masterKey</code>），并通过<code>BroadcastChannel</code>广播 “主标签页宣告”（<code>master-announcement</code>），同步状态给所有从标签页。</li><li>从标签页监听<code>localStorage</code>变化和广播消息，确认主标签页身份，避免重复连接。</li></ul><h3 id="_2-主标签页心跳检测-确保主标签页存活" tabindex="-1"><a class="header-anchor" href="#_2-主标签页心跳检测-确保主标签页存活"><span>2. 主标签页心跳检测（确保主标签页存活）</span></a></h3><p>为防止主标签页崩溃、关闭或失去响应后导致整个 SSE 服务中断，设计了心跳检测机制：</p><ul><li><strong>从标签页发起心跳检查</strong>：从标签页每 30 秒通过<code>BroadcastChannel</code>发送<code>ping</code>消息给主标签页。</li><li><strong>主标签页响应心跳</strong>：主标签页收到<code>ping</code>后，立即返回<code>pong</code>消息。</li><li><strong>超时处理</strong>：从标签页发送<code>ping</code>后设置 5 秒超时器（<code>refreshTimeout</code>），若未收到<code>pong</code>，判定主标签页失效，触发重新选举（<code>electionMaster()</code>）。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 从标签页定期发送ping并检测超时</span></span>
<span class="line"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;ping&quot;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;主标签页心跳超时，触发重新选举&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5秒超时</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每30秒检查一次</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 主标签页响应pong</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;ping&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-标签页状态监控-管理活跃标签页生命周期" tabindex="-1"><a class="header-anchor" href="#_3-标签页状态监控-管理活跃标签页生命周期"><span>3. 标签页状态监控（管理活跃标签页生命周期）</span></a></h3><p>为准确维护标签页列表、及时清理无效标签页，设计了标签页状态监控机制：</p><ul><li><strong>活跃标签页注册与注销</strong>： <ul><li>标签页初始化时通过<code>registerActiveTab()</code>将自身添加到<code>localStorage</code>的活跃列表（<code>activeTabsKey</code>），包含<code>tabId</code>、<code>instanceId</code>（唯一标识，避免刷新冲突）和时间戳。</li><li>标签页关闭 / 刷新时通过<code>unregisterActiveTab()</code>从活跃列表移除自身，并在列表为空时重置计数器和主标签页标识。</li></ul></li><li><strong>过期标签页清理</strong>：通过<code>cleanExpiredTabs()</code>定期清理 5 分钟内未更新时间戳的标签页（视为已关闭或失效），确保活跃列表准确。</li><li><strong>活跃状态更新</strong>：每 60 秒通过定时器更新当前标签页的时间戳，标记为 “活跃”，避免被误判为过期。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 定期更新当前标签页时间戳（保持活跃）</span></span>
<span class="line"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> activeTabs <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeTabsKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;[]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> tabIndex <span class="token operator">=</span> activeTabs<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">tab</span> <span class="token operator">=&gt;</span> tab<span class="token punctuation">.</span>instanceId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tabInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>tabIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    activeTabs<span class="token punctuation">[</span>tabIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新时间戳</span></span>
<span class="line">    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeTabsKey<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>activeTabs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每分钟更新一次</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-连接管理与重连机制-确保-sse-连接稳定" tabindex="-1"><a class="header-anchor" href="#_4-连接管理与重连机制-确保-sse-连接稳定"><span>4. 连接管理与重连机制（确保 SSE 连接稳定）</span></a></h3><p>主标签页负责维护与后端的 SSE 连接，通过重连机制处理网络波动或连接失败：</p><ul><li><strong>连接状态标识</strong>：通过<code>isConnected</code>（是否连接）、<code>isConnecting</code>（是否正在连接）跟踪状态，避免重复连接。</li><li>重连策略： <ul><li>连接失败时触发<code>handleReconnect()</code>，采用<strong>指数退避策略</strong>（重连间隔从 3 秒开始，每次翻倍，最大 30 秒）。</li><li>限制最大重连次数（默认 5 次），超过后停止重连并触发<code>max-reconnect-reached</code>事件。</li></ul></li><li><strong>引用计数</strong>：通过<code>referenceCount</code>跟踪对 SSE 服务的引用（如组件使用），仅当计数为 0 时才真正断开连接，避免频繁连接 / 断开。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 指数退避重连</span></span>
<span class="line"><span class="token keyword">const</span> baseDelay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectInterval <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token number">30000</span> <span class="token comment">// 最大延迟30秒</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> baseDelay<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-跨标签页消息同步-基于-broadcastchannel" tabindex="-1"><a class="header-anchor" href="#_5-跨标签页消息同步-基于-broadcastchannel"><span>5. 跨标签页消息同步（基于 BroadcastChannel）</span></a></h3><p>通过<code>BroadcastChannel</code>实现主从标签页的消息同步：</p><ul><li>主标签页接收 SSE 消息后，通过<code>broadcastSSEMessage()</code>将消息广播给所有从标签页（如<code>device-online</code>、<code>device-offline</code>等事件）。</li><li>从标签页监听广播消息，触发本地事件回调，实现与主标签页的状态同步。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 主标签页广播消息</span></span>
<span class="line"><span class="token function">broadcastSSEMessage</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;sse-message&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> eventType<span class="token punctuation">,</span> payload <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 从标签页接收消息并触发事件</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;sse-message&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>eventType<span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h3><p>该代码通过<strong>主从模式</strong>解决多标签页连接限制，通过<strong>心跳检测</strong>确保主标签页有效性，通过<strong>状态监控</strong>管理标签页生命周期，通过<strong>重连机制</strong>保证连接稳定性，最终实现了高效、可靠的跨标签页 SSE 实时消息推送服务。</p><h2 id="源代码" tabindex="-1"><a class="header-anchor" href="#源代码"><span>源代码</span></a></h2><p>此处我为原有的SSE连接文件（<code>sseService.js</code>）添加BroadcastChannel 的主从模式逻辑以突破SSE的连接限制，选择主标签页的规则是先到先得，所有标签页都关闭的时候清除选举的标签页标志，也就是 <strong>Localstorage</strong> 里的标志。当然在撰写代码的同时也要注意主标签页如果被用户叉掉或者刷新，被刷新的标签页的id会进行重置，则要进行重新选举。</p>`,77)),t("p",null,[n[1]||(n[1]=s("源代码：",-1)),e(a,{to:"/posts/codes/sseServiceWithBroadcastChannel.html"},{default:p(()=>[...n[0]||(n[0]=[s("sseServiceWithBroadcastChannel.js",-1)])]),_:1})]),t("p",null,[n[3]||(n[3]=s("相关文章：",-1)),e(a,{to:"/posts/sse/BroadcastChannel%E7%89%88%E6%9C%ACsse%E8%A7%A3%E8%AF%BB.html"},{default:p(()=>[...n[2]||(n[2]=[s("BroadcastChannel版本sse文件解读.md",-1)])]),_:1})])])}const m=c(d,[["render",k]]),h=JSON.parse('{"path":"/posts/sse/BroadcastChannel%E6%96%B9%E5%BC%8F%E8%A7%A3%E5%86%B3sse%E8%BF%9E%E6%8E%A5%E6%95%B0%E9%99%90%E5%88%B6.html","title":"SSE最大连接次数突破","lang":"zh-CN","frontmatter":{"date":"2025-11-27T00:00:00.000Z","category":["经验总结"],"tag":["BroadcastChannel","SSE"]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[{"level":3,"title":"核心思想","slug":"核心思想","link":"#核心思想","children":[]}]},{"level":2,"title":"原理机制详解","slug":"原理机制详解","link":"#原理机制详解","children":[{"level":3,"title":"1. 通信基础：BroadcastChannel","slug":"_1-通信基础-broadcastchannel","link":"#_1-通信基础-broadcastchannel","children":[]},{"level":3,"title":"2. 主从选举机制","slug":"_2-主从选举机制","link":"#_2-主从选举机制","children":[]},{"level":3,"title":"3. 消息广播机制","slug":"_3-消息广播机制","link":"#_3-消息广播机制","children":[]},{"level":3,"title":"4. 故障转移机制","slug":"_4-故障转移机制","link":"#_4-故障转移机制","children":[]}]},{"level":2,"title":"需要改其他业务逻辑代码吗？","slug":"需要改其他业务逻辑代码吗","link":"#需要改其他业务逻辑代码吗","children":[{"level":3,"title":"具体使用方式（与之前兼容）","slug":"具体使用方式-与之前兼容","link":"#具体使用方式-与之前兼容","children":[]},{"level":3,"title":"核心原因","slug":"核心原因","link":"#核心原因","children":[]}]},{"level":2,"title":"核心设计","slug":"核心设计","link":"#核心设计","children":[{"level":3,"title":"1. 主从标签页模式（突破 SSE 连接限制）","slug":"_1-主从标签页模式-突破-sse-连接限制","link":"#_1-主从标签页模式-突破-sse-连接限制","children":[]},{"level":3,"title":"2. 主标签页心跳检测（确保主标签页存活）","slug":"_2-主标签页心跳检测-确保主标签页存活","link":"#_2-主标签页心跳检测-确保主标签页存活","children":[]},{"level":3,"title":"3. 标签页状态监控（管理活跃标签页生命周期）","slug":"_3-标签页状态监控-管理活跃标签页生命周期","link":"#_3-标签页状态监控-管理活跃标签页生命周期","children":[]},{"level":3,"title":"4. 连接管理与重连机制（确保 SSE 连接稳定）","slug":"_4-连接管理与重连机制-确保-sse-连接稳定","link":"#_4-连接管理与重连机制-确保-sse-连接稳定","children":[]},{"level":3,"title":"5. 跨标签页消息同步（基于 BroadcastChannel）","slug":"_5-跨标签页消息同步-基于-broadcastchannel","link":"#_5-跨标签页消息同步-基于-broadcastchannel","children":[]},{"level":3,"title":"总结","slug":"总结","link":"#总结","children":[]}]},{"level":2,"title":"源代码","slug":"源代码","link":"#源代码","children":[]}],"git":{"updatedTime":1765271411000,"contributors":[{"name":"ksldnasx","username":"ksldnasx","email":"wh8261408@126.com","commits":10,"url":"https://github.com/ksldnasx"}],"changelog":[{"hash":"38f5d2d76c8dd864b56b327c069ef5bcfd035c0c","time":1765271411000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix: link change"},{"hash":"acd93ed23f26117dad056c26ee821ccbe6fb6c2e","time":1765250440000,"email":"wh8261408@126.com","author":"ksldnasx","message":"style:开始页样式大改 fix:链接正确修改"},{"hash":"a0089923dda5b0a1e568fce8d29533128e78ce23","time":1765244359000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:各类文件布局"},{"hash":"305509a2698c63f4713ace6497663dcf57d07dbd","time":1764640332000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:修改文章筛选条件，增加标题展示语句"},{"hash":"1e6f5a9933d7b094d5a4a3df91b6f285913bd880","time":1764324107000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:开始页面链接补全"},{"hash":"d9d7cdf943cd72ac0e02f5dfd986a904f9e0eee7","time":1764323248000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat:实习周总结4"},{"hash":"9be085721b208a8eed7c4344c669706800e0c95a","time":1764239888000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat:更新BroadcastChannel说明文档以及代码"},{"hash":"2bb520acae22a117a27fd7e8c01104d70ee96664","time":1764225688000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix: unable to fix 版本兼容问题"},{"hash":"a2a314287506333e731e326d75d1bfe87f0ae720","time":1764215696000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:tag名称修复"},{"hash":"1bf4d21ff2fc9192ba869a7769c179396f8bcad0","time":1764215677000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat: sse学习以及BoradcastChannel"}]},"filePathRelative":"posts/sse/BroadcastChannel方式解决sse连接数限制.md","excerpt":"\\n<h2>前言</h2>\\n<p>在我们建立sse连接的时候，由于<strong>HTTP/1.1</strong>的限制，在该协议下，大多数现代浏览器（如Chrome、Firefox、Edge）对<strong>同一域名（协议+域名+端口）的并发连接数限制通常为6个</strong>。这意味着，同一个浏览器标签页（或同一浏览器实例）中，对相同域名最多只能同时建立约6个SSE连接，超出此数量的新连接会被浏览器阻塞，直到有连接被关闭。</p>\\n<p>若需要突破此限制，可考虑以下方案：</p>\\n<table>\\n<thead>\\n<tr>\\n<th style=\\"text-align:left\\">解决方案</th>\\n<th style=\\"text-align:left\\">描述</th>\\n<th style=\\"text-align:left\\">适用场景</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td style=\\"text-align:left\\"><strong>升级至HTTP/2</strong></td>\\n<td style=\\"text-align:left\\">HTTP/2支持<strong>多路复用</strong>，可在单个TCP连接上并行处理多个请求和响应，从而从根本上解决连接数限制问题。</td>\\n<td style=\\"text-align:left\\"><strong>长远和推荐方案</strong>，需服务器和浏览器支持，通常要求使用HTTPS。</td>\\n</tr>\\n<tr>\\n<td style=\\"text-align:left\\"><strong>多域名/多端口策略</strong></td>\\n<td style=\\"text-align:left\\">将SSE连接分散到不同的子域（如<code>sse1.example.com</code>, <code>sse2.example.com</code>）或不同端口号。每个子域或端口享有独立的6个连接限额。</td>\\n<td style=\\"text-align:left\\"><strong>过渡方案</strong>，适用于暂无法升级HTTP/2的情况，但配置管理稍复杂。</td>\\n</tr>\\n<tr>\\n<td style=\\"text-align:left\\"><strong>优化连接使用</strong></td>\\n<td style=\\"text-align:left\\">利用标签页切换及时关闭不再需要的SSE连接，或尝试将多个数据流合并到一个SSE连接中传输（通过不同事件类型区分）。</td>\\n<td style=\\"text-align:left\\"><strong>基础优化</strong>，良好的连接管理习惯。</td>\\n</tr>\\n</tbody>\\n</table>"}');export{m as comp,h as data};
