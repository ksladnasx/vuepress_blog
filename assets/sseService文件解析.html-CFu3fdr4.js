import{_ as e,c as t,d as s,a as c,f as a,g as l,w as i,h as o,o as u}from"./app-UmXydJji.js";const r={};function d(k,n){const p=o("RouteLink");return u(),t("div",null,[n[2]||(n[2]=s("h1",{id:"sseæœåŠ¡ä»£ç è§£è¯»",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#sseæœåŠ¡ä»£ç è§£è¯»"},[s("span",null,"SSEæœåŠ¡ä»£ç è§£è¯»")])],-1)),s("p",null,[n[1]||(n[1]=a("å®Œæ•´ä»£ç åœ°å€ï¼š",-1)),l(p,{to:"/posts/codes/sseService.html"},{default:i(()=>[...n[0]||(n[0]=[a("sseService.js",-1)])]),_:1})]),n[3]||(n[3]=c(`<p>è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„SSEï¼ˆServer-Sent Eventsï¼‰å®¢æˆ·ç«¯æœåŠ¡ç±»ï¼Œç”¨äºæ¥æ”¶åç«¯å®æ—¶æ¨é€çš„è®¾å¤‡çŠ¶æ€å˜åŒ–é€šçŸ¥ã€‚ä»¥ä¸‹æ˜¯å¯¹ä»£ç çš„è¯¦ç»†è§£è¯»ï¼š</p><h2 id="ğŸ—ï¸-æ•´ä½“æ¶æ„è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ğŸ—ï¸-æ•´ä½“æ¶æ„è®¾è®¡"><span>ğŸ—ï¸ æ•´ä½“æ¶æ„è®¾è®¡</span></a></h2><h3 id="å•ä¾‹æ¨¡å¼å®ç°" tabindex="-1"><a class="header-anchor" href="#å•ä¾‹æ¨¡å¼å®ç°"><span>å•ä¾‹æ¨¡å¼å®ç°</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// åˆ›å»ºå…¨å±€å•ä¾‹å®ä¾‹ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªSSEè¿æ¥</span></span>
<span class="line"><span class="token keyword">let</span> sseServiceInstance <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">getSseService</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sseServiceInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    sseServiceInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSEService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> sseServiceInstance</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ ¸å¿ƒå±æ€§è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒå±æ€§è¯´æ˜"><span>æ ¸å¿ƒå±æ€§è¯´æ˜</span></a></h3><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>eventSource</code></td><td>EventSource</td><td>åŸç”ŸSSEè¿æ¥å¯¹è±¡</td></tr><tr><td><code>listeners</code></td><td>Map</td><td>äº‹ä»¶ç›‘å¬å™¨é›†åˆ</td></tr><tr><td><code>referenceCount</code></td><td>number</td><td><strong>å¼•ç”¨è®¡æ•°æœºåˆ¶</strong>ï¼Œæ”¯æŒå¤šç»„ä»¶å…±äº«</td></tr><tr><td><code>isConnected</code>/<code>isConnecting</code></td><td>boolean</td><td>è¿æ¥çŠ¶æ€ç®¡ç†</td></tr></tbody></table><h2 id="ğŸ”„-æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶"><span>ğŸ”„ æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶</span></a></h2><ol><li>å¼•ç”¨è®¡æ•°ç®¡ç†</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// è¿æ¥æ—¶å¢åŠ è®¡æ•°</span></span>
<span class="line"><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>referenceCount<span class="token operator">++</span></span>
<span class="line">  <span class="token comment">// åªæœ‰ç¬¬ä¸€ä¸ªå¼•ç”¨æ‰çœŸæ­£å»ºç«‹è¿æ¥</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ–­å¼€æ—¶å‡å°‘è®¡æ•°</span></span>
<span class="line"><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>referenceCount<span class="token operator">--</span></span>
<span class="line">  <span class="token comment">// åªæœ‰è®¡æ•°ä¸º0æ—¶æ‰çœŸæ­£æ–­å¼€è¿æ¥</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¼˜åŠ¿</strong>ï¼šå¤šä¸ªUIç»„ä»¶å¯ä»¥ç‹¬ç«‹ä½¿ç”¨SSEæœåŠ¡ï¼Œæ— éœ€æ‹…å¿ƒé‡å¤è¿æ¥æˆ–è¿‡æ—©æ–­å¼€ã€‚</p><ol start="2"><li>æ™ºèƒ½é‡è¿ç­–ç•¥</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æŒ‡æ•°é€€é¿ç®—æ³•ï¼šé‡è¿å»¶è¿Ÿéšå°è¯•æ¬¡æ•°å¢åŠ </span></span>
<span class="line">  <span class="token keyword">const</span> baseDelay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectInterval <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">    <span class="token number">30000</span> <span class="token comment">// æœ€å¤§å»¶è¿Ÿ30ç§’</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶ï¼ˆ5æ¬¡ï¼‰</li><li>é¿å…ç½‘ç»œæ‹¥å¡çš„é€€é¿ç­–ç•¥</li><li>è¿æ¥çŠ¶æ€æ£€æŸ¥é˜²æ­¢é‡å¤é‡è¿</li></ul><ol start="3"><li>å®Œæ•´çš„äº‹ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// äº‹ä»¶ç›‘å¬å™¨ç®¡ç†</span></span>
<span class="line"><span class="token function">on</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>    <span class="token comment">// æ³¨å†Œç›‘å¬</span></span>
<span class="line"><span class="token function">off</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>   <span class="token comment">// ç§»é™¤ç›‘å¬  </span></span>
<span class="line"><span class="token function">emit</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> data<span class="token punctuation">)</span>      <span class="token comment">// è§¦å‘äº‹ä»¶</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ”¯æŒçš„äº‹ä»¶ç±»å‹</span></span>
<span class="line"><span class="token string">&#39;device-registered&#39;</span>    <span class="token comment">// è®¾å¤‡æ³¨å†Œ</span></span>
<span class="line"><span class="token string">&#39;device-online&#39;</span>        <span class="token comment">// è®¾å¤‡ä¸Šçº¿  </span></span>
<span class="line"><span class="token string">&#39;device-offline&#39;</span>       <span class="token comment">// è®¾å¤‡ç¦»çº¿</span></span>
<span class="line"><span class="token string">&#39;device-alert&#39;</span>         <span class="token comment">// è®¾å¤‡å‘Šè­¦</span></span>
<span class="line"><span class="token string">&#39;statistics-update&#39;</span>    <span class="token comment">// ç»Ÿè®¡æ›´æ–°</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸŒ-è¿æ¥é…ç½®ä¸urlå¤„ç†" tabindex="-1"><a class="header-anchor" href="#ğŸŒ-è¿æ¥é…ç½®ä¸urlå¤„ç†"><span>ğŸŒ è¿æ¥é…ç½®ä¸URLå¤„ç†</span></a></h2><p>ç¯å¢ƒè‡ªé€‚åº”URLæ„å»º</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// å¼€å‘ç¯å¢ƒï¼šå®Œæ•´URL</span></span>
<span class="line"><span class="token comment">// ç”Ÿäº§ç¯å¢ƒï¼šç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡nginxä»£ç†ï¼‰</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>sseEndpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/device/notifications/sse</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>sseEndpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/device/notifications/sse</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿æ¥è¶…æ—¶æ§åˆ¶</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> connectionTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnected<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;SSEè¿æ¥è¶…æ—¶&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span> <span class="token comment">// 2åˆ†é’Ÿè¶…æ—¶ï¼Œé€‚åº”ç”Ÿäº§ç¯å¢ƒ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ›¡ï¸-å¥å£®æ€§è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ğŸ›¡ï¸-å¥å£®æ€§è®¾è®¡"><span>ğŸ›¡ï¸ å¥å£®æ€§è®¾è®¡</span></a></h2><p>é”™è¯¯å¤„ç†ä¸æ¢å¤</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line">eventSource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æ ¹æ®readyStateé‡‡å–ä¸åŒç­–ç•¥</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è¿æ¥å…³é—­æ—¶é‡è¿</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// CONNECTING/OPENçŠ¶æ€ä¸‹çš„é”™è¯¯æœ‰ä¸åŒå¤„ç†é€»è¾‘</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>èµ„æºæ¸…ç†æœºåˆ¶</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">setupPageUnloadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// é¡µé¢å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-ç›‘æ§ä¸è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-ç›‘æ§ä¸è¯Šæ–­"><span>ğŸ“Š ç›‘æ§ä¸è¯Šæ–­</span></a></h2><p>è¿æ¥çŠ¶æ€ç›‘æ§</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">startConnectionMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ¯30ç§’æ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è‡ªåŠ¨æ¢å¤æ–­å¼€çš„è¿æ¥</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¦ç»†çš„æ—¥å¿—è®°å½•</p><p>ä»£ç ä¸­åŒ…å«å¤§é‡<code>console.log</code>è¯­å¥ï¼Œä¾¿äºï¼š</p><ul><li>è°ƒè¯•è¿æ¥é—®é¢˜</li><li>ç›‘æ§äº‹ä»¶æµ</li><li>è¯Šæ–­ç½‘ç»œå¼‚å¸¸</li></ul><h2 id="ğŸ¯-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-ä½¿ç”¨ç¤ºä¾‹"><span>ğŸ¯ ä½¿ç”¨ç¤ºä¾‹</span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨</span></span>
<span class="line"><span class="token keyword">import</span> sseService <span class="token keyword">from</span> <span class="token string">&#39;./sse-service&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç›‘å¬è®¾å¤‡ä¸Šçº¿äº‹ä»¶</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡ä¸Šçº¿:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment">// æ›´æ–°UIçŠ¶æ€</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å»ºç«‹è¿æ¥</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶å¸è½½æ—¶æ–­å¼€è¿æ¥</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ’¡-è®¾è®¡äº®ç‚¹" tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-è®¾è®¡äº®ç‚¹"><span>ğŸ’¡ è®¾è®¡äº®ç‚¹</span></a></h2><ol><li><strong>å•ä¸€èŒè´£</strong>ï¼šä¸“æ³¨SSEè¿æ¥ç®¡ç†ï¼Œä¸æºæ‚ä¸šåŠ¡é€»è¾‘</li><li><strong>å®¹é”™æ€§å¼º</strong>ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤æœºåˆ¶</li><li><strong>èµ„æºå‹å¥½</strong>ï¼šå¼•ç”¨è®¡æ•°é¿å…é‡å¤è¿æ¥ï¼ŒåŠæ—¶æ¸…ç†èµ„æº</li><li><strong>å¯æ‰©å±•</strong>ï¼šäº‹ä»¶æœºåˆ¶ä¾¿äºåŠŸèƒ½æ‰©å±•</li><li><strong>ç”Ÿäº§å°±ç»ª</strong>ï¼šè€ƒè™‘å¤šç§è¾¹ç¼˜æƒ…å†µå’Œç½‘ç»œç¯å¢ƒ</li></ol><h2 id="äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶"><span><strong>äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶</strong></span></a></h2><p>ä»£ç è§£æ</p><p>ä»¥ä»¥ä¸‹ä»£ç ä¸ºä¾‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"> <span class="token function">on</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>æ•°æ®ç»“æ„è§£æ</li></ol><p><code>this.listeners</code>æ˜¯ä»€ä¹ˆï¼Ÿ</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// listeners æ˜¯ä¸€ä¸ª Map æ•°æ®ç»“æ„ï¼Œå­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">  <span class="token comment">// é”®(key): äº‹ä»¶ç±»å‹(string)</span></span>
<span class="line">  <span class="token comment">// å€¼(value): å›è°ƒå‡½æ•°æ•°ç»„(Array&lt;Function&gt;)</span></span>
<span class="line">  </span>
<span class="line">  <span class="token punctuation">[</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback1<span class="token punctuation">,</span> callback2<span class="token punctuation">,</span> callback3<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback4<span class="token punctuation">,</span> callback5<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback6<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>ä»£ç æ‰§è¡Œæ­¥éª¤åˆ†è§£</li></ol><p>æ­¥éª¤1ï¼šæ£€æŸ¥äº‹ä»¶ç±»å‹æ˜¯å¦å·²å­˜åœ¨</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½œç”¨</strong>ï¼š</p><ul><li>æ£€æŸ¥ <code>this.listeners</code>Map ä¸­æ˜¯å¦å·²ç»æœ‰è¿™ä¸ª <code>eventType</code>çš„æ¡ç›®</li><li>å¦‚æœæ²¡æœ‰ï¼ˆå³ç¬¬ä¸€æ¬¡æ³¨å†Œè¯¥äº‹ä»¶ç±»å‹ï¼‰ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ä½œä¸ºå€¼</li><li>ç›¸å½“äºåˆå§‹åŒ–è¿™ä¸ªäº‹ä»¶ç±»å‹çš„ç›‘å¬å™¨åˆ—è¡¨</li></ul><p><strong>ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ç¬¬ä¸€æ¬¡æ³¨å†Œ &#39;device-online&#39; äº‹ä»¶</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">)</span> <span class="token comment">// false</span></span>
<span class="line"><span class="token comment">// æ‰§è¡Œåï¼šåˆ›å»ºç©ºæ•°ç»„</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// ç°åœ¨ï¼šlisteners = Map { &#39;device-online&#39; =&gt; [] }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¥éª¤2ï¼šæ·»åŠ å›è°ƒå‡½æ•°åˆ°å¯¹åº”æ•°ç»„</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>ä½œç”¨</strong>ï¼š</p><p>getæŸ¥æ‰¾åˆ°å…¶åœ¨å­—å…¸ä¸­çš„å­—æ®µï¼Œpushå°†å‡½æ•°æ·»åŠ åˆ°è¯¥å­—æ®µå¯¹åº”çš„å€¼ä¸Š</p><ul><li>é€šè¿‡ <code>eventType</code>è·å–å¯¹åº”çš„å›è°ƒå‡½æ•°æ•°ç»„</li><li>å°†æ–°çš„ <code>callback</code>å‡½æ•°æ·»åŠ åˆ°æ•°ç»„æœ«å°¾</li></ul><p><strong>ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// æ³¨å†Œç¬¬ä¸€ä¸ªç›‘å¬å™¨</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> callback1<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// listeners = Map { &#39;device-online&#39; =&gt; [callback1] }</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ³¨å†Œç¬¬äºŒä¸ªç›‘å¬å™¨ï¼ˆåŒä¸€äº‹ä»¶ç±»å‹ï¼‰</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> callback2<span class="token punctuation">)</span>  </span>
<span class="line"><span class="token comment">// listeners = Map { &#39;device-online&#39; =&gt; [callback1, callback2] }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>å®é™…ä½¿ç”¨ç¤ºä¾‹</li></ol><p>åœºæ™¯ï¼šå¤šä¸ªç»„ä»¶ç›‘å¬åŒä¸€äº‹ä»¶</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ç»„ä»¶A - è®¾å¤‡åˆ—è¡¨</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»„ä»¶A: è®¾å¤‡ä¸Šçº¿&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// æ›´æ–°è®¾å¤‡åˆ—è¡¨çš„UIæ˜¾ç¤º</span></span>
<span class="line">    <span class="token function">updateDeviceStatus</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token string">&#39;online&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶B - ç»Ÿè®¡é¢æ¿  </span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»„ä»¶B: è®¾å¤‡ä¸Šçº¿&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// æ›´æ–°åœ¨çº¿è®¾å¤‡è®¡æ•°</span></span>
<span class="line">    onlineCount<span class="token punctuation">.</span>value<span class="token operator">++</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶C - å®æ—¶é€šçŸ¥</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»„ä»¶C: è®¾å¤‡ä¸Šçº¿&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥</span></span>
<span class="line">    <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">è®¾å¤‡ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>data<span class="token punctuation">.</span>deviceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> å·²ä¸Šçº¿</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å½“è®¾å¤‡ä¸Šçº¿äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰€æœ‰3ä¸ªå›è°ƒå‡½æ•°éƒ½ä¼šæ‰§è¡Œ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> Map <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&#39;device-online&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ç»„ä»¶Açš„å›è°ƒ */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ç»„ä»¶Bçš„å›è°ƒ */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ç»„ä»¶Cçš„å›è°ƒ */</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;device-offline&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token comment">// å…¶ä»–äº‹ä»¶çš„å›è°ƒå‡½æ•°...</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>ä¸ <code>emit</code>æ–¹æ³•çš„é…åˆ</li></ol><p>äº‹ä»¶è§¦å‘æµç¨‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// å½“æ”¶åˆ°SSEæ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨emitè§¦å‘äº‹ä»¶</span></span>
<span class="line"><span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è·å–è¯¥äº‹ä»¶ç±»å‹çš„æ‰€æœ‰å›è°ƒå‡½æ•°</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment">// ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå›è°ƒå‡½æ•°</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œé”™è¯¯:</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä½¿ç”¨ç¤ºä¾‹ï¼š</span></span>
<span class="line"><span class="token comment">// æ”¶åˆ°åç«¯æ¨é€ï¼šæ‰§è¡Œ emit(&#39;device-online&#39;, deviceData)</span></span>
<span class="line"><span class="token comment">// ç»“æœï¼šç»„ä»¶Aã€Bã€Cçš„å›è°ƒå‡½æ•°éƒ½ä¼šæ”¶åˆ°deviceDataå¹¶æ‰§è¡Œ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>è®¾è®¡æ¨¡å¼çš„ä¼˜åŠ¿</li></ol><p>è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰</p><p>è¿™ç§è®¾è®¡å®ç°äº†ç»å…¸çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ä¸»é¢˜ï¼ˆSubjectï¼‰ - SSEæœåŠ¡</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">SSEService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// è§‚å¯Ÿè€…åˆ—è¡¨</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ³¨å†Œè§‚å¯Ÿè€…</span></span>
<span class="line">    <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ... ä¸Šé¢çš„å®ç°</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é€šçŸ¥è§‚å¯Ÿè€…</span></span>
<span class="line">    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ... è§¦å‘æ‰€æœ‰å›è°ƒ</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è§‚å¯Ÿè€…ï¼ˆObserversï¼‰ - å„ä¸ªç»„ä»¶</span></span>
<span class="line">componentA<span class="token punctuation">.</span><span class="token function-variable function">onDeviceOnline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* å¤„ç†é€»è¾‘ */</span> <span class="token punctuation">}</span></span>
<span class="line">componentB<span class="token punctuation">.</span><span class="token function-variable function">onDeviceOnline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* å¤„ç†é€»è¾‘ */</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ³¨å†Œè§‚å¯Ÿè€…</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> componentA<span class="token punctuation">.</span>onDeviceOnline<span class="token punctuation">)</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> componentB<span class="token punctuation">.</span>onDeviceOnline<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>å®é™…ä¸šåŠ¡åœºæ™¯</li></ol><p>æ¨¡å—åŒ–çš„äº‹ä»¶å¤„ç†</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// è®¾å¤‡ç®¡ç†æ¨¡å—</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">DeviceManager</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceOnline</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceOffline</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceAlert</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">handleDeviceOnline</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä¸“é—¨çš„è®¾å¤‡ä¸Šçº¿å¤„ç†é€»è¾‘</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDeviceCache</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token string">&#39;online&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refreshDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ... å…¶ä»–å¤„ç†æ–¹æ³•</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å‘Šè­¦ç®¡ç†æ¨¡å—  </span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AlertManager</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleNewAlert</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceRecovery</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">handleNewAlert</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä¸“é—¨çš„å‘Šè­¦å¤„ç†é€»è¾‘</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">storeAlert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyUsers</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ... å…¶ä»–å¤„ç†æ–¹æ³•</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>æ€»ç»“</li></ol><p>è¿™ä¸ª <code>on</code>æ–¹æ³•çš„æ ¸å¿ƒä½œç”¨ï¼š</p><ol><li><strong>äº‹ä»¶æ³¨å†Œ</strong>ï¼šå…è®¸ä¸åŒçš„ä»£ç æ¨¡å—æ³¨å†Œå¯¹ç‰¹å®šäº‹ä»¶çš„å…´è¶£</li><li><strong>å¤šç›‘å¬å™¨æ”¯æŒ</strong>ï¼šåŒä¸€äº‹ä»¶ç±»å‹å¯ä»¥æ³¨å†Œå¤šä¸ªå›è°ƒå‡½æ•°</li><li><strong>è§£è€¦è®¾è®¡</strong>ï¼šäº‹ä»¶æºï¼ˆSSEæœåŠ¡ï¼‰å’Œäº‹ä»¶å¤„ç†é€»è¾‘ï¼ˆå„ä¸ªç»„ä»¶ï¼‰å®Œå…¨è§£è€¦</li><li><strong>çµæ´»æ‰©å±•</strong>ï¼šå¯ä»¥åŠ¨æ€æ·»åŠ /ç§»é™¤äº‹ä»¶ç›‘å¬å™¨</li></ol><p>è¿™ç§è®¾è®¡è®©SSEæœåŠ¡æˆä¸ºäº†ä¸€ä¸ª<strong>äº‹ä»¶æ€»çº¿</strong>ï¼Œå„ä¸ªä¸šåŠ¡æ¨¡å—åªéœ€è¦å…³å¿ƒè‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œè€Œä¸éœ€è¦çŸ¥é“å…¶ä»–æ¨¡å—çš„å­˜åœ¨ï¼Œå¤§å¤§æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p><h2 id="sseæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#sseæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£"><span>SSEæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£</span></a></h2><h3 id="ğŸ¯-äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†"><span>ğŸ¯ äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†</span></a></h3><p>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>Map</code>å­˜å‚¨ç›‘å¬å™¨ï¼Ÿ</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>è®¾è®¡åŸå› ï¼š</strong></p><ol><li><strong>äº‹ä»¶ç±»å‹ä½œä¸ºé”®</strong> - æ¯ä¸ªäº‹ä»¶ç±»å‹(<code>device-online</code>, <code>device-offline</code>ç­‰)å¯¹åº”ä¸€ä¸ªå›è°ƒå‡½æ•°æ•°ç»„</li><li><strong>æ”¯æŒå¤šä¸ªç›‘å¬å™¨</strong> - åŒä¸€äº‹ä»¶å¯ä»¥æœ‰å¤šä¸ªå¤„ç†å‡½æ•°</li><li><strong>å¿«é€ŸæŸ¥æ‰¾</strong> - Mapçš„é”®æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦O(1)</li><li><strong>å†…å­˜ç®¡ç†</strong> - ä¾¿äºç²¾ç¡®æ·»åŠ /ç§»é™¤ç›‘å¬å™¨</li></ol><blockquote><p>listeners æ˜¯ä¸€ä¸ª Map æ•°æ®ç»“æ„ï¼Œå­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</p><p>this.listeners = new Map([</p><p><em>// é”®(key): äº‹ä»¶ç±»å‹(string)</em></p><p><em>// å€¼(value): å›è°ƒå‡½æ•°æ•°ç»„(Array&lt;å‡½æ•°&gt;)</em></p><p>[&#39;device-online&#39;, [callback1, callback2, callback3]],</p><p>[&#39;device-offline&#39;, [callback4, callback5]],</p><p>[&#39;device-alert&#39;, [callback6]],</p><p><em>// ...</em></p><p>])</p></blockquote><h3 id="ğŸ”§-äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ"><span>ğŸ”§ äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ</span></a></h3><h4 id="_1-ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_1-ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶"><span>1. ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// é¦–æ¬¡æ³¨å†Œæ—¶åˆ›å»ºæ•°ç»„</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>  <span class="token comment">// æ·»åŠ å›è°ƒåˆ°æ•°ç»„</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼š</strong></p><ul><li><strong>åŠ¨æ€æ‰©å±•</strong> - ä¸éœ€è¦é¢„å…ˆå®šä¹‰æ‰€æœ‰äº‹ä»¶ç±»å‹</li><li><strong>æ‰¹é‡å¤„ç†</strong> - åŒä¸€äº‹ä»¶çš„æ‰€æœ‰å›è°ƒå­˜å‚¨åœ¨æ•°ç»„ä¸­</li><li><strong>æœ‰åºæ‰§è¡Œ</strong> - å›è°ƒæŒ‰æ·»åŠ é¡ºåºæ‰§è¡Œ</li></ul><h4 id="_2-äº‹ä»¶è§¦å‘æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-äº‹ä»¶è§¦å‘æœºåˆ¶"><span>2. äº‹ä»¶è§¦å‘æœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment">// æ‰§è¡Œæ¯ä¸ªå›è°ƒå‡½æ•°</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œé”™è¯¯ [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å…³é”®è®¾è®¡ç‚¹ï¼š</strong></p><ul><li><strong>é”™è¯¯éš”ç¦»</strong> - å•ä¸ªå›è°ƒé”™è¯¯ä¸å½±å“å…¶ä»–å›è°ƒ</li><li><strong>æ•°æ®ä¼ é€’</strong> - ç»Ÿä¸€çš„æ•°æ®æ ¼å¼ä¼ é€’</li><li><strong>ç©ºå®‰å…¨</strong> - æ£€æŸ¥äº‹ä»¶ç±»å‹æ˜¯å¦å­˜åœ¨</li></ul><h4 id="_3-ç›‘å¬å™¨ç§»é™¤æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-ç›‘å¬å™¨ç§»é™¤æœºåˆ¶"><span>3. ç›‘å¬å™¨ç§»é™¤æœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">off</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> index <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      callbacks<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// ç²¾ç¡®ç§»é™¤æŒ‡å®šå›è°ƒ</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è®¾è®¡ä¼˜åŠ¿ï¼š</strong></p><ul><li><strong>ç²¾ç¡®æ§åˆ¶</strong> - å¯ä»¥ç§»é™¤ç‰¹å®šçš„å›è°ƒå‡½æ•°</li><li><strong>å†…å­˜å‹å¥½</strong> - é¿å…å†…å­˜æ³„æ¼</li><li><strong>çµæ´»ç®¡ç†</strong> - æ”¯æŒä¸´æ—¶ç›‘å¬å’Œæ°¸ä¹…ç›‘å¬</li></ul><h3 id="ğŸª-å®é™…è°ƒç”¨æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#ğŸª-å®é™…è°ƒç”¨æ–¹å¼"><span>ğŸª å®é™…è°ƒç”¨æ–¹å¼</span></a></h3><h4 id="åœ¨vueç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#åœ¨vueç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹"><span>åœ¨Vueç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// åœ¨Vueç»„ä»¶ä¸­</span></span>
<span class="line"><span class="token keyword">import</span> sseService <span class="token keyword">from</span> <span class="token string">&#39;./sseService&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ - è¿™æ‰æ˜¯æ­£ç¡®çš„è°ƒç”¨æ–¹å¼ï¼</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOnline<span class="token punctuation">)</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOffline<span class="token punctuation">)</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceAlert<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿æ¥SSEæœåŠ¡</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è®¾å¤‡ä¸Šçº¿å¤„ç†å‡½æ•°</span></span>
<span class="line">    <span class="token function">handleDeviceOnline</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡ä¸Šçº¿:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&#39;UPDATE_DEVICE_STATUS&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">deviceId</span><span class="token operator">:</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;online&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾å¤‡ç¦»çº¿å¤„ç†å‡½æ•°  </span></span>
<span class="line">    <span class="token function">handleDeviceOffline</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡ç¦»çº¿:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">è®¾å¤‡ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>data<span class="token punctuation">.</span>deviceName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> å·²ç¦»çº¿</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾å¤‡å‘Šè­¦å¤„ç†å‡½æ•°</span></span>
<span class="line">    <span class="token function">handleDeviceAlert</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡å‘Šè­¦:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">triggerAlarmSound</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">displayAlertPopup</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ç»„ä»¶é”€æ¯æ—¶ç§»é™¤ç›‘å¬å™¨ - é‡è¦ï¼</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOnline<span class="token punctuation">)</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOffline<span class="token punctuation">)</span> </span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceAlert<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ–­å¼€SSEè¿æ¥</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºä»€ä¹ˆè¿™æ ·è°ƒç”¨" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆè¿™æ ·è°ƒç”¨"><span>ä¸ºä»€ä¹ˆè¿™æ ·è°ƒç”¨ï¼Ÿ</span></a></h4><p><strong>1. åˆ†ç¦»å…³æ³¨ç‚¹</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// âŒ é”™è¯¯æ–¹å¼ï¼šåœ¨SSEæœåŠ¡ä¸­ç¡¬ç¼–ç ä¸šåŠ¡é€»è¾‘</span></span>
<span class="line">eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// è¿™é‡Œç›´æ¥å†™UIæ›´æ–°é€»è¾‘ï¼Œè€¦åˆåº¦é«˜</span></span>
<span class="line">  <span class="token function">updateUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">sendNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">playSound</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// âœ… æ­£ç¡®æ–¹å¼ï¼šSSEæœåŠ¡åªè´Ÿè´£äº‹ä»¶åˆ†å‘</span></span>
<span class="line">eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token comment">// çº¯æ•°æ®ä¼ é€’ï¼Œæ— ä¸šåŠ¡é€»è¾‘</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. æ”¯æŒå¤šç»„ä»¶ç›‘å¬</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ç»„ä»¶A - è®¾å¤‡ç®¡ç†é¡µé¢</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refreshDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// åˆ·æ–°è®¾å¤‡åˆ—è¡¨</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶B - å‘Šè­¦ä¸­å¿ƒ  </span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateStatistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶C - å®æ—¶ç›‘æ§å¤§å±</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDashboard</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// æ›´æ–°ç›‘æ§é¢æ¿</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ‰€æœ‰ç»„ä»¶éƒ½ä¼šæ”¶åˆ°åŒä¸€ä¸ªäº‹ä»¶ï¼Œå„è‡ªå¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. åŠ¨æ€äº‹ä»¶ç®¡ç†</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ä¸´æ—¶ç›‘å¬ - åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹ç›‘å¬</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">tempHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>severity <span class="token operator">===</span> <span class="token string">&#39;high&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleCriticalAlert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// å¤„ç†å®Œåç§»é™¤ç›‘å¬å™¨</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> tempHandler<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> tempHandler<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ¡ä»¶æ€§ç›‘å¬</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userRole <span class="token operator">===</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;statistics-update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleAdminStats<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ”„-äº‹ä»¶è§¦å‘æµç¨‹" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-äº‹ä»¶è§¦å‘æµç¨‹"><span>ğŸ”„ äº‹ä»¶è§¦å‘æµç¨‹</span></a></h3><h4 id="å®Œæ•´çš„äº‹ä»¶æµè½¬" tabindex="-1"><a class="header-anchor" href="#å®Œæ•´çš„äº‹ä»¶æµè½¬"><span>å®Œæ•´çš„äº‹ä»¶æµè½¬</span></a></h4><div class="language-markdown line-numbers-mode" data-highlighter="prismjs" data-ext="md"><pre><code><span class="line">æœåŠ¡å™¨å‘é€äº‹ä»¶ </span>
<span class="line">    â†“</span>
<span class="line">EventSourceæ¥æ”¶åˆ°åŸå§‹äº‹ä»¶</span>
<span class="line">    â†“  </span>
<span class="line">è§£æäº‹ä»¶æ•°æ® JSON.parse(event.data)</span>
<span class="line">    â†“</span>
<span class="line">è°ƒç”¨ emit(&#39;event-type&#39;, parsedData)</span>
<span class="line">    â†“</span>
<span class="line">æŸ¥æ‰¾Mapä¸­å¯¹åº”äº‹ä»¶ç±»å‹çš„æ‰€æœ‰å›è°ƒå‡½æ•°</span>
<span class="line">    â†“  </span>
<span class="line">æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªå›è°ƒå‡½æ•°</span>
<span class="line">    â†“</span>
<span class="line">å„ç»„ä»¶å¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é”™è¯¯å¤„ç†æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#é”™è¯¯å¤„ç†æœºåˆ¶"><span>é”™è¯¯å¤„ç†æœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// æ‰§è¡Œå›è°ƒ</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å…³é”®ï¼šå•ä¸ªå›è°ƒé”™è¯¯ä¸å½±å“å…¶ä»–å›è°ƒ</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œé”™è¯¯ [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// å¯ä»¥æ·»åŠ é”™è¯¯ä¸ŠæŠ¥é€»è¾‘</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> eventType<span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ’¡-è®¾è®¡ä¼˜åŠ¿æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-è®¾è®¡ä¼˜åŠ¿æ€»ç»“"><span>ğŸ’¡ è®¾è®¡ä¼˜åŠ¿æ€»ç»“</span></a></h3><ol><li><strong>è§£è€¦æ€§å¼º</strong> - SSEæœåŠ¡ä¸å…³å¿ƒå…·ä½“ä¸šåŠ¡é€»è¾‘</li><li><strong>æ‰©å±•æ€§å¥½</strong> - æ–°ç»„ä»¶å¯ä»¥è½»æ¾æ·»åŠ ç›‘å¬</li><li><strong>ç»´æŠ¤æ€§é«˜</strong> - äº‹ä»¶å¤„ç†é€»è¾‘åˆ†æ•£åœ¨å„ç»„ä»¶</li><li><strong>é”™è¯¯éš”ç¦»</strong> - å•ä¸ªç›‘å¬å™¨é”™è¯¯ä¸å½±å“æ•´ä½“</li><li><strong>å†…å­˜å®‰å…¨</strong> - æ”¯æŒç²¾ç¡®çš„ç›‘å¬å™¨ç®¡ç†</li></ol><p>è¿™ç§è®¾è®¡è®©SSEæœåŠ¡æˆä¸ºä¸€ä¸ªçº¯ç²¹çš„<strong>äº‹ä»¶ä¸­è½¬ç«™</strong>ï¼Œä¸šåŠ¡ç»„ä»¶æŒ‰éœ€è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå®ç°äº†å®Œç¾çš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚</p>`,114))])}const m=e(r,[["render",d]]),b=JSON.parse('{"path":"/posts/sse/sseService%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90.html","title":"SSEæœåŠ¡ä»£ç è§£è¯»","lang":"zh-CN","frontmatter":{"date":"2025-11-25T00:00:00.000Z","category":["ä»£ç è§£è¯»"],"tag":["SSE"]},"headers":[{"level":2,"title":"ğŸ—ï¸ æ•´ä½“æ¶æ„è®¾è®¡","slug":"ğŸ—ï¸-æ•´ä½“æ¶æ„è®¾è®¡","link":"#ğŸ—ï¸-æ•´ä½“æ¶æ„è®¾è®¡","children":[{"level":3,"title":"å•ä¾‹æ¨¡å¼å®ç°","slug":"å•ä¾‹æ¨¡å¼å®ç°","link":"#å•ä¾‹æ¨¡å¼å®ç°","children":[]},{"level":3,"title":"æ ¸å¿ƒå±æ€§è¯´æ˜","slug":"æ ¸å¿ƒå±æ€§è¯´æ˜","link":"#æ ¸å¿ƒå±æ€§è¯´æ˜","children":[]}]},{"level":2,"title":"ğŸ”„ æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶","slug":"ğŸ”„-æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶","link":"#ğŸ”„-æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶","children":[]},{"level":2,"title":"ğŸŒ è¿æ¥é…ç½®ä¸URLå¤„ç†","slug":"ğŸŒ-è¿æ¥é…ç½®ä¸urlå¤„ç†","link":"#ğŸŒ-è¿æ¥é…ç½®ä¸urlå¤„ç†","children":[]},{"level":2,"title":"ğŸ›¡ï¸ å¥å£®æ€§è®¾è®¡","slug":"ğŸ›¡ï¸-å¥å£®æ€§è®¾è®¡","link":"#ğŸ›¡ï¸-å¥å£®æ€§è®¾è®¡","children":[]},{"level":2,"title":"ğŸ“Š ç›‘æ§ä¸è¯Šæ–­","slug":"ğŸ“Š-ç›‘æ§ä¸è¯Šæ–­","link":"#ğŸ“Š-ç›‘æ§ä¸è¯Šæ–­","children":[]},{"level":2,"title":"ğŸ¯ ä½¿ç”¨ç¤ºä¾‹","slug":"ğŸ¯-ä½¿ç”¨ç¤ºä¾‹","link":"#ğŸ¯-ä½¿ç”¨ç¤ºä¾‹","children":[]},{"level":2,"title":"ğŸ’¡ è®¾è®¡äº®ç‚¹","slug":"ğŸ’¡-è®¾è®¡äº®ç‚¹","link":"#ğŸ’¡-è®¾è®¡äº®ç‚¹","children":[]},{"level":2,"title":"äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶","slug":"äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶","link":"#äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶","children":[]},{"level":2,"title":"SSEæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£","slug":"sseæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£","link":"#sseæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£","children":[{"level":3,"title":"ğŸ¯ äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†","slug":"ğŸ¯-äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†","link":"#ğŸ¯-äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†","children":[]},{"level":3,"title":"ğŸ”§ äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ","slug":"ğŸ”§-äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ","link":"#ğŸ”§-äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ","children":[]},{"level":3,"title":"ğŸª å®é™…è°ƒç”¨æ–¹å¼","slug":"ğŸª-å®é™…è°ƒç”¨æ–¹å¼","link":"#ğŸª-å®é™…è°ƒç”¨æ–¹å¼","children":[]},{"level":3,"title":"ğŸ”„ äº‹ä»¶è§¦å‘æµç¨‹","slug":"ğŸ”„-äº‹ä»¶è§¦å‘æµç¨‹","link":"#ğŸ”„-äº‹ä»¶è§¦å‘æµç¨‹","children":[]},{"level":3,"title":"ğŸ’¡ è®¾è®¡ä¼˜åŠ¿æ€»ç»“","slug":"ğŸ’¡-è®¾è®¡ä¼˜åŠ¿æ€»ç»“","link":"#ğŸ’¡-è®¾è®¡ä¼˜åŠ¿æ€»ç»“","children":[]}]}],"git":{"updatedTime":1765271411000,"contributors":[{"name":"ksldnasx","username":"ksldnasx","email":"wh8261408@126.com","commits":9,"url":"https://github.com/ksldnasx"}],"changelog":[{"hash":"38f5d2d76c8dd864b56b327c069ef5bcfd035c0c","time":1765271411000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix: link change"},{"hash":"acd93ed23f26117dad056c26ee821ccbe6fb6c2e","time":1765250440000,"email":"wh8261408@126.com","author":"ksldnasx","message":"style:å¼€å§‹é¡µæ ·å¼å¤§æ”¹ fix:é“¾æ¥æ­£ç¡®ä¿®æ”¹"},{"hash":"a0089923dda5b0a1e568fce8d29533128e78ce23","time":1765244359000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:å„ç±»æ–‡ä»¶å¸ƒå±€"},{"hash":"305509a2698c63f4713ace6497663dcf57d07dbd","time":1764640332000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:ä¿®æ”¹æ–‡ç« ç­›é€‰æ¡ä»¶ï¼Œå¢åŠ æ ‡é¢˜å±•ç¤ºè¯­å¥"},{"hash":"d9d7cdf943cd72ac0e02f5dfd986a904f9e0eee7","time":1764323248000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat:å®ä¹ å‘¨æ€»ç»“4"},{"hash":"62952a15f28ebf90d81fa23654b6a5d5c4285e78","time":1764240090000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix:åˆ†ç±»ä¿®æ­£ï¼Œæ ‡é¢˜ä¿®æ”¹"},{"hash":"2bb520acae22a117a27fd7e8c01104d70ee96664","time":1764225688000,"email":"wh8261408@126.com","author":"ksldnasx","message":"fix: unable to fix ç‰ˆæœ¬å…¼å®¹é—®é¢˜"},{"hash":"1bf4d21ff2fc9192ba869a7769c179396f8bcad0","time":1764215677000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat: sseå­¦ä¹ ä»¥åŠBoradcastChannel"},{"hash":"82986032106d89195676536db2e6efd6060346b6","time":1764041784000,"email":"wh8261408@126.com","author":"ksldnasx","message":"feat:æ–°å¢sseç›¸å…³é¡µé¢ã€‚fix:get-startedé¡µé¢ä¿®æ”¹"}]},"filePathRelative":"posts/sse/sseServiceæ–‡ä»¶è§£æ.md","excerpt":"\\n<p>å®Œæ•´ä»£ç åœ°å€ï¼š<a href=\\"/vuepress_blog/posts/codes/sseService.html\\" target=\\"_blank\\">sseService.js</a></p>\\n<p>è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„SSEï¼ˆServer-Sent Eventsï¼‰å®¢æˆ·ç«¯æœåŠ¡ç±»ï¼Œç”¨äºæ¥æ”¶åç«¯å®æ—¶æ¨é€çš„è®¾å¤‡çŠ¶æ€å˜åŒ–é€šçŸ¥ã€‚ä»¥ä¸‹æ˜¯å¯¹ä»£ç çš„è¯¦ç»†è§£è¯»ï¼š</p>\\n<h2>ğŸ—ï¸ æ•´ä½“æ¶æ„è®¾è®¡</h2>\\n<h3>å•ä¾‹æ¨¡å¼å®ç°</h3>\\n<div class=\\"language-javascript line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"js\\"><pre><code><span class=\\"line\\"><span class=\\"token comment\\">// åˆ›å»ºå…¨å±€å•ä¾‹å®ä¾‹ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªSSEè¿æ¥</span></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">let</span> sseServiceInstance <span class=\\"token operator\\">=</span> <span class=\\"token keyword\\">null</span></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">const</span> <span class=\\"token function-variable function\\">getSseService</span> <span class=\\"token operator\\">=</span> <span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span> <span class=\\"token operator\\">=&gt;</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">  <span class=\\"token keyword\\">if</span> <span class=\\"token punctuation\\">(</span><span class=\\"token operator\\">!</span>sseServiceInstance<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">    sseServiceInstance <span class=\\"token operator\\">=</span> <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">SSEService</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\">  <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\">  <span class=\\"token keyword\\">return</span> sseServiceInstance</span>\\n<span class=\\"line\\"><span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{m as comp,b as data};
