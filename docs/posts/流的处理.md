---
date: 2025-11-26
category:
  - ä»£ç è§£è¯»
tag:
  - SSE
  - fetchApi
---

# å¯¹åŸºç¡€ SSE ä¸­æµçš„å¤„ç†çš„è§£è¯»

## è§£æ

è¿™æ˜¯ä¸€æ®µå®ç°å‰ç«¯æµå¼æ¥æ”¶å’Œå¤„ç† SSEï¼ˆServer-Sent Eventsï¼‰æ•°æ®çš„ä»£ç ï¼Œå®ƒæ²¡æœ‰ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„`EventSource`ï¼Œè€Œæ˜¯é‡‡ç”¨`fetch`é…åˆæµå¼è¯»å–æ¥è·å–å¹¶å¤„ç†æ•°æ®ï¼Œä»è€Œå®ç°äº†é€å­—è¾“å‡ºçš„æ•ˆæœã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€éƒ¨åˆ†è§£æã€‚

ğŸŒŸ æ³¨æ„æ ¸å¿ƒæ˜¯åœ¨`processStream`å‡½æ•°å†…éƒ¨ï¼Œå½“å¤„ç†å®Œä¸€ä¸ªæ•°æ®å—åï¼Œå®ƒå†æ¬¡è°ƒç”¨`reader.read().then(processStream)`ï¼Œä»è€Œå½¢æˆä¸€ä¸ªé€’å½’è°ƒç”¨é“¾ï¼Œç›´åˆ°æµç»“æŸï¼ˆ`done`ä¸º`true`ï¼‰

### ğŸ å‡½æ•°å®šä¹‰ä¸åˆå§‹è®¾ç½®

```js
const startStream = async () => {
  if (isStreaming.value) return;

  try {
    outputText.value = '';
    isStreaming.value = true;
```

- `const startStream = async () => {`ï¼šå®šä¹‰ä¸€ä¸ªåä¸º`startStream`çš„å¼‚æ­¥ç®­å¤´å‡½æ•°ï¼Œå› ä¸ºå®ƒå†…éƒ¨ä½¿ç”¨äº†`await`ã€‚
- `if (isStreaming.value) return;`ï¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨æµå¼ä¼ è¾“ä¸­ï¼ˆ`isStreaming`å¯èƒ½æ˜¯ä¸€ä¸ª Vue çš„ ref å“åº”å¼å˜é‡ï¼‰ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›ï¼Œé˜²æ­¢é‡å¤è¯·æ±‚ã€‚
- `outputText.value = '';`ï¼šæ¸…ç©ºæ˜¾ç¤ºæ–‡æœ¬çš„å“åº”å¼å˜é‡ï¼Œå‡†å¤‡æ¥æ”¶æ–°æ•°æ®ã€‚
- `isStreaming.value = true;`ï¼šå°†æµå¼ä¼ è¾“çŠ¶æ€è®¾ç½®ä¸º`true`ï¼Œè¡¨ç¤ºè¯·æ±‚å·²å¼€å§‹ã€‚

### ğŸŒ å‘èµ·è¯·æ±‚ä¸è·å–æ•°æ®æµ

```js
const response = await fetch("http://localhost:3000/stream-text");
if (!response.ok || !response.body) {
  throw new Error("æµè¯·æ±‚å¤±è´¥");
}

const reader = response.body.getReader();
const decoder = new TextDecoder();
```

- `const response = await fetch('http://localhost:3000/stream-text');`ï¼šä½¿ç”¨`fetch`API å‘èµ·ä¸€ä¸ª GET è¯·æ±‚åˆ°æŒ‡å®šçš„ SSE ç«¯ç‚¹ã€‚`await`ä¼šç­‰å¾…ç›´åˆ°æ¥æ”¶åˆ°æœåŠ¡å™¨çš„å“åº”å¤´ã€‚
- `if (!response.ok || !response.body) { ... }`ï¼šæ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸï¼ˆçŠ¶æ€ç  200-299ï¼‰ä»¥åŠå“åº”ä½“ï¼ˆ`body`ï¼‰æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä»»ä¸€æ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ã€‚
- `const reader = response.body.getReader();`ï¼šä»å“åº”ä½“ä¸­è·å–ä¸€ä¸ª**å¯è¯»æµè¯»å–å™¨**ï¼ˆ`ReadableStreamDefaultReader`ï¼‰ã€‚è¿™ä¸ªè¯»å–å™¨å…è®¸ä½ é€æ­¥è¯»å–å“åº”ä½“ä¸­çš„æ•°æ®å—ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨å†…å®¹ã€‚è°ƒç”¨`getReader()`æ–¹æ³•ä¼š**é”å®š**è¿™ä¸ªæµï¼Œä½¿å…¶ä¸èƒ½è¢«å…¶ä»–è¯»å–å™¨ä½¿ç”¨ã€‚
- `const decoder = new TextDecoder();`ï¼šåˆ›å»ºä¸€ä¸ª`TextDecoder`å¯¹è±¡ï¼Œç”¨äºå°†æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ•°æ®å—ï¼ˆé€šå¸¸æ˜¯`Uint8Array`ï¼‰è§£ç æˆå­—ç¬¦ä¸²ã€‚å®ƒé»˜è®¤ä½¿ç”¨ UTF-8 ç¼–ç ã€‚

### ğŸ”„ å¤„ç†æ•°æ®æµçš„æ ¸å¿ƒè¿‡ç¨‹

```js
const processStream = ({ done, value }) => {
      if (done) {
        isStreaming.value = false;
        return;
      }

      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');
```

- `const processStream = ({ done, value }) => { ... }`ï¼šå®šä¹‰äº†ä¸€ä¸ªå¤„ç†æ•°æ®å—çš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå¯¹è±¡å‚æ•°ï¼Œè¯¥å¯¹è±¡åŒ…å«`done`å’Œ`value`ä¸¤ä¸ªå±æ€§ã€‚ `done`ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæµæ˜¯å¦å·²ç»å…¨éƒ¨è¯»å–å®Œæ¯•ã€‚ `value`ï¼šä¸€ä¸ª`Uint8Array`ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®å—ï¼Œæ˜¯æœ¬æ¬¡è¯»å–åˆ°çš„å†…å®¹ã€‚
- `if (done) { ... }`ï¼šå¦‚æœæµå·²ç»“æŸï¼Œåˆ™æ›´æ–°çŠ¶æ€å¹¶é€€å‡ºå‡½æ•°ã€‚
- `const chunk = decoder.decode(value, { stream: true });`ï¼šä½¿ç”¨`TextDecoder`çš„`decode`æ–¹æ³•å°†äºŒè¿›åˆ¶æ•°æ®å—è§£ç æˆå­—ç¬¦ä¸²ã€‚**å…³é”®ç‚¹åœ¨äº`{ stream: true }`è¿™ä¸ªé€‰é¡¹**ï¼šå®ƒå‘Šè¯‰è§£ç å™¨æ•°æ®æ˜¯åˆ†å—ä¼ è¾“çš„ï¼Œå¯èƒ½åŒ…å«ä¸å®Œæ•´çš„å­—ç¬¦ï¼ˆæ¯”å¦‚å¤šå­—èŠ‚å­—ç¬¦å¦‚ä¸­æ–‡è¢«åˆ†å‰²åœ¨ä¸åŒçš„æ•°æ®å—ä¸­ï¼‰ï¼Œè§£ç å™¨ä¼šä¿ç•™è¿™äº›ä¸å®Œæ•´çš„å­—èŠ‚åºåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡`decode`è°ƒç”¨æ—¶å†ç»„åˆæˆå®Œæ•´çš„å­—ç¬¦ï¼Œä»è€Œé¿å…ä¹±ç ã€‚
- `const lines = chunk.split('\n');`ï¼šSSE åè®®ä¸­ï¼Œæ¯æ¡æ¶ˆæ¯ä»¥æ¢è¡Œç¬¦åˆ†éš”ã€‚è¿™é‡Œå°†è§£ç åçš„å­—ç¬¦ä¸²æŒ‰è¡Œåˆ†å‰²ï¼Œä¾¿äºé€è¡Œå¤„ç†ã€‚

### ğŸ“¨ è§£æ SSE æ¶ˆæ¯æ ¼å¼

```js
for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.substring(6));
            ...
          } catch (e) {
            console.error('è§£ææ¶ˆæ¯é”™è¯¯:', e);
          }
        }
      }
```

- `if (line.startsWith('data: '))`ï¼šæ£€æŸ¥ä¸€è¡Œæ˜¯å¦ä»¥`"data: "`å¼€å¤´ã€‚è¿™æ˜¯ SSE åè®®è§„å®šçš„**æ•°æ®è¡Œæ ¼å¼**ï¼Œæœ‰æ•ˆæ•°æ®ç´§è·Ÿå…¶åã€‚
- `const data = JSON.parse(line.substring(6));`ï¼šæå–`"data: "`ä¹‹åçš„å†…å®¹ï¼ˆ`line.substring(6)`ï¼‰ï¼Œå¹¶å°†å…¶ä½œä¸º JSON å­—ç¬¦ä¸²è§£ææˆ JavaScript å¯¹è±¡ã€‚ä½ çš„ç¤ºä¾‹ä¸­ï¼ŒæœåŠ¡å™¨å‘é€çš„æ•°æ®ç»“æ„å¯èƒ½åŒ…å«`char`ï¼ˆå­—ç¬¦ï¼‰ã€`done`ï¼ˆç»“æŸæ ‡å¿—ï¼‰ç­‰å­—æ®µã€‚

### âœ¨ æ›´æ–°ç•Œé¢ä¸é€’å½’è¯»å–

```js
if (data.done) {
  isStreaming.value = false;
  return;
}

if (data.char === "\n") {
  outputText.value += "\n";
} else {
  outputText.value += data.char;
}

nextTick(() => {
  if (outputElement.value) {
    outputElement.value.scrollTop = outputElement.value.scrollHeight;
  }
});
```

- æ ¹æ®è§£æåçš„`data`å¯¹è±¡æ›´æ–°ç•Œé¢ï¼š å¦‚æœ`data.done`ä¸º`true`ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å‘é€å®Œæ¯•ï¼Œæ›´æ–°çŠ¶æ€å¹¶è¿”å›ã€‚ æ ¹æ®`data.char`æ˜¯æ¢è¡Œç¬¦è¿˜æ˜¯æ™®é€šå­—ç¬¦ï¼Œå°†å…¶è¿½åŠ åˆ°æ˜¾ç¤ºæ–‡æœ¬`outputText.value`ä¸­ï¼Œå®ç°**é€å­—è¾“å‡º**çš„æ•ˆæœã€‚
- `nextTick(() => { ... });`ï¼šåœ¨ DOM æ›´æ–°åï¼Œå°†æ˜¾ç¤ºåŒºåŸŸçš„æ»šåŠ¨æ¡æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æœ€æ–°å†…å®¹å¯è§ã€‚`nextTick`æ˜¯ Vue.js æä¾›çš„æ–¹æ³•ã€‚

```js
return reader.read().then(processStream);
    };
    reader.read().then(processStream);
```

- `reader.read().then(processStream);`ï¼šè¿™æ˜¯å®ç°**æµå¼è¯»å–çš„æ ¸å¿ƒå¾ªç¯**ã€‚ `reader.read()`æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œå…¶è§£æå€¼å°±æ˜¯åŒ…å«`done`å’Œ`value`çš„å¯¹è±¡ã€‚ åœ¨`processStream`å‡½æ•°å†…éƒ¨ï¼Œå½“å¤„ç†å®Œä¸€ä¸ªæ•°æ®å—åï¼Œå®ƒå†æ¬¡è°ƒç”¨`reader.read().then(processStream)`ï¼Œä»è€Œå½¢æˆä¸€ä¸ªé€’å½’è°ƒç”¨é“¾ï¼Œç›´åˆ°æµç»“æŸï¼ˆ`done`ä¸º`true`ï¼‰ã€‚è¿™ç§æ–¹å¼ç¡®ä¿æ•°æ®ä¸€æ¥å°±å¤„ç†ï¼Œå®ç°äº†çœŸæ­£çš„æµå¼æ¥æ”¶ã€‚

### ğŸ›¡ï¸ é”™è¯¯å¤„ç†

```js
} catch (error) {
    console.error('æµå¼è¯·æ±‚é”™è¯¯:', error);
    isStreaming.value = false;
  }
}
```

- ä½¿ç”¨`try...catch`æ•è·æ•´ä¸ªæµå¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ï¼ˆå¦‚ç½‘ç»œé”™è¯¯ã€è§£æé”™è¯¯ç­‰ï¼‰ï¼Œåœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå¹¶ç¡®ä¿å°†æµå¼ä¼ è¾“çŠ¶æ€`isStreaming.value`é‡ç½®ä¸º`false`ã€‚

### ğŸ’ æ ¸å¿ƒæœºåˆ¶æ€»ç»“

è¿™æ®µä»£ç çš„å…³é”®åœ¨äº**ä½¿ç”¨`fetch`çš„æµå¼ API é€æ­¥è¯»å–å’Œå¤„ç† SSE æ•°æ®**ï¼Œè€Œéä¸€æ¬¡æ€§åŠ è½½ã€‚å®ƒé€šè¿‡`getReader()`è·å–æ•°æ®æµè¯»å–å™¨ï¼Œå¾ªç¯è°ƒç”¨`read()`æ–¹æ³•è¯»å–æ•°æ®å—ï¼Œç”¨`TextDecoder`è§£ç ï¼ˆæ³¨æ„`{ stream: true }`é€‰é¡¹ï¼‰ï¼Œå¹¶æŒ‰ç…§ SSE åè®®è§£ææ•°æ®è¡Œï¼Œæœ€ç»ˆå®ç°é€å­—æ›´æ–°çš„è§†è§‰æ•ˆæœã€‚

å¸Œæœ›è¿™ä¸ªè¯¦ç»†çš„è§£é‡Šèƒ½å¸®åŠ©ä½ ç†è§£è¿™æ®µä»£ç çš„è¿ä½œæœºåˆ¶ï¼

## å®Œæ•´ä»£ç 

```js
const startStream = async () => {
  if (isStreaming.value) return;

  try {
    outputText.value = "";
    isStreaming.value = true;

    const response = await fetch("http://localhost:3000/stream-text");
    if (!response.ok || !response.body) {
      throw new Error("æµè¯·æ±‚å¤±è´¥");
    }

    //å°†ä¼ æ¥ çš„äºŒè¿›åˆ¶æ•°æ®æµè½¬æ¢ä¸ºæ–‡æœ¬
    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    const processStream = ({ done, value }) => {
      if (done) {
        isStreaming.value = false;
        return;
      }

      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split("\n");

      for (const line of lines) {
        if (line.startsWith("data: ")) {
          try {
            const data = JSON.parse(line.substring(6));

            if (data.done) {
              isStreaming.value = false;
              return;
            }

            if (data.char === "\n") {
              outputText.value += "\n";
            } else {
              outputText.value += data.char;
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            nextTick(() => {
              if (outputElement.value) {
                outputElement.value.scrollTop =
                  outputElement.value.scrollHeight;
              }
            });
          } catch (e) {
            console.error("è§£ææ¶ˆæ¯é”™è¯¯:", e);
          }
        }
      }

      return reader.read().then(processStream);
    };
    reader.read().then(processStream);
  } catch (error) {
    console.error("æµå¼è¯·æ±‚é”™è¯¯:", error);
    isStreaming.value = false;
  }
};
```
