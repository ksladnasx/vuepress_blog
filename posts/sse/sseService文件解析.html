<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" defer></script><title>SSEæœåŠ¡ä»£ç è§£è¯» | xh's blog </title><meta name="description" content="A VuePress bolg Site for personal useage">
    <link rel="preload" href="/vuepress_blog/assets/style-DHqMCh0M.css" as="style"><link rel="stylesheet" href="/vuepress_blog/assets/style-DHqMCh0M.css">
    <link rel="modulepreload" href="/vuepress_blog/assets/app-UmXydJji.js"><link rel="modulepreload" href="/vuepress_blog/assets/sseServiceæ–‡ä»¶è§£æ.html-CFu3fdr4.js">
    <link rel="prefetch" href="/vuepress_blog/assets/get-started.html-BrW2OPcu.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-S6-rR0CJ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/åˆçº§å¤§æ¨¡å‹ç®—æ³•å·¥ç¨‹å¸ˆå…¥é—¨å…¥é—¨è§„åˆ’.html-PUD1hSiK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/æ“ä½œç³»ç»Ÿ.html-YNNKIn6e.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/æ“ä½œç³»ç»Ÿä¾‹é¢˜è®²è§£.html-B-6_ekdl.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/æ“ä½œç³»ç»Ÿè¯¾åé¢˜ç›®.html-DlApKp0k.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/æ“ä½œç³»ç»Ÿé‡éš¾ç‚¹.html-M5l9okRE.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/ç½‘ç»œåè®®åˆ†æ.html-B0mjkNCX.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/ç½‘ç»œåè®®åˆ†æé¢˜.html-yvjyltqR.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/ç½‘ç»œå®‰å…¨.html-fOPBAX77.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/ç½‘ç»œå®‰å…¨é‡ç‚¹.html-DGVv5IzC.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/è½¯ä»¶å®šä¹‰ç½‘ç»œ.html-C67XijOI.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/è½¯ä»¶å®šä¹‰ç½‘ç»œé‡ç‚¹.html-6Z3iflPr.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/è½¯ä»¶å®šä¹‰ç½‘ç»œé¢˜.html-BU6JilnL.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SSEDemoFronted.html-CkMTwiLD.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/sseDomeServer.html-CMTtiZ0q.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/sseService.html-DLsLrZ5r.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/sseServiceWithBroadcastChannel.html-92dTtKay.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/dockeréƒ¨ç½²æµç¨‹.html-DqTH97bC.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å…¨æ ˆå¼€å‘.html-VUAWgHhY.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/é¡¹ç›®ç»éªŒ.html-DUtouFrA.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å®ä¹ å‘¨æ€»ç»“1.html-DaCt6wvi.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å®ä¹ å‘¨æ€»ç»“2.html-BY7LBVJh.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å®ä¹ å‘¨æ€»ç»“3.html-C5mwoDrK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å®ä¹ å‘¨æ€»ç»“4.html-CBxQOGEn.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å®ä¹ å‘¨æ€»ç»“5.html-DCgmTcP6.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å®ä¹ ç»éªŒ.html-Dkk6S6Zk.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å‰ç«¯é¢è¯•å…«è‚¡æ–‡.html-DQw4HnpF.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/åŸºç¡€ç®—æ³•.html-CLOvrdrI.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å€’è´§ç»éªŒæ€»ç»“.html-CL4iQ_7G.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/todolistå»ºç«‹.html-B5EjdCgT.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/ç¡…è°·ç”„é€‰é¡¹ç›®ç¬”è®°.html-DqHEbjP1.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/docsifyé¡¹ç›®åˆ›å»ºä¸éƒ¨ç½².html-CpLorkJ_.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/æ’ä»¶å…¬å¼ç¤ºä¾‹.html-B33CRABu.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/ç®—æ³•åˆ·é¢˜.html-CXEaZEAR.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/ç»„ä»¶ä¼ å€¼ä¸ä»£ç è§„èŒƒ.html-DaePJcxq.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/nuxt.html-BVl7vC9r.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Nuxt4.html-De03BzNK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/reactå…¥é—¨.html-DfLkVr-w.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/reactå°å®è·µ.html-DOHkAIiK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/å†œæ‹…é¡¹ç›®æ‰€é‡é—®é¢˜åŠæ€»ç»“.html-DyTzNiLQ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Http.html-BpCPFPFy.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Nginx.html-DwHWNYWU.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/element-plus.html-Dt0Shoe-.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/vitest.html-BbKkgsi4.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Vuepressä¸Šæ‰‹.html-DYIwU6Ih.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Vueæ¢ç´¢.html-qlFs5-z_.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/BroadcastChannelæ–¹å¼è§£å†³sseè¿æ¥æ•°é™åˆ¶.html-6GwTFg2t.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/BroadcastChannelç‰ˆæœ¬sseè§£è¯».html-Adx7YZ9b.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SSEå®è·µæµ‹è¯•.html-CjSzpvRb.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SSEç®€ä»‹.html-D_5DeskR.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/æµçš„å¤„ç†.html-tw-jDSu6.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/404.html-472gSdLs.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-D4Vr1x4U.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-D8BmJRWK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DtbrREu1.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CgGRLfzl.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-NnkC358F.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C3eHk0Vo.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-HpkemBGh.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BX-QMr8T.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C3D2GhaK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BPrdVcRz.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CCEYsNkj.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-B2JiFNeM.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Bt2CbkVn.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DzDHRR9E.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Clc2oEJx.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-cvbG_VKD.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-jmKdmd-f.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Bw9losca.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-COZGe3TG.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Bo82Xr6G.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DUExu0Mr.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DlomL8bU.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DbNnBFIB.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BYZrx3C-.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-lH_oohfr.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CM3W7KJs.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BTsj8QAg.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C9z1iF9P.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BLMxlOAl.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BAbqhVZZ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-B3MMSr5C.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DI57HGoX.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DjiCImKB.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C3CBBVRX.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DoDaI2dM.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-zq0tpgC6.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-B_2lmY7-.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-RbGocMDB.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CdlxNR7n.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-D7Fl-7bv.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CoM2O_F8.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CU0fp3Et.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CYcDJCeV.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-_3AD9UeM.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SearchResult-Dq26a1PS.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/browser-B92KtQ1J.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/social-share-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/giscus-DrGxERkK.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/vuepress_blog/"><!----><span class="vp-site-name vp-hide-mobile" aria-hidden="true">xh&#39;s blog </span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/article/" aria-label="æ–‡ç« "><!--[--><!--[--><!--]--><!--]-->æ–‡ç« <!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/category/" aria-label="åˆ†ç±»"><!--[--><!--[--><!--]--><!--]-->åˆ†ç±»<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/tag/" aria-label="æ ‡ç­¾"><!--[--><!--[--><!--]--><!--]-->æ ‡ç­¾<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/timeline/" aria-label="æ—¶é—´çº¿"><!--[--><!--[--><!--]--><!--]-->æ—¶é—´çº¿<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="slimsearch-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">æœç´¢</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/article/" aria-label="æ–‡ç« "><!--[--><!--[--><!--]--><!--]-->æ–‡ç« <!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/category/" aria-label="åˆ†ç±»"><!--[--><!--[--><!--]--><!--]-->åˆ†ç±»<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/tag/" aria-label="æ ‡ç­¾"><!--[--><!--[--><!--]--><!--]-->æ ‡ç­¾<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/timeline/" aria-label="æ—¶é—´çº¿"><!--[--><!--[--><!--]--><!--]-->æ—¶é—´çº¿<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">SSEæœåŠ¡ä»£ç è§£è¯» <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="sseæœåŠ¡ä»£ç è§£è¯»" tabindex="-1"><a class="header-anchor" href="#sseæœåŠ¡ä»£ç è§£è¯»"><span>SSEæœåŠ¡ä»£ç è§£è¯»</span></a></h1><p>å®Œæ•´ä»£ç åœ°å€ï¼š<a class="route-link" href="/vuepress_blog/posts/codes/sseService.html">sseService.js</a></p><p>è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„SSEï¼ˆServer-Sent Eventsï¼‰å®¢æˆ·ç«¯æœåŠ¡ç±»ï¼Œç”¨äºæ¥æ”¶åç«¯å®æ—¶æ¨é€çš„è®¾å¤‡çŠ¶æ€å˜åŒ–é€šçŸ¥ã€‚ä»¥ä¸‹æ˜¯å¯¹ä»£ç çš„è¯¦ç»†è§£è¯»ï¼š</p><h2 id="ğŸ—ï¸-æ•´ä½“æ¶æ„è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ğŸ—ï¸-æ•´ä½“æ¶æ„è®¾è®¡"><span>ğŸ—ï¸ æ•´ä½“æ¶æ„è®¾è®¡</span></a></h2><h3 id="å•ä¾‹æ¨¡å¼å®ç°" tabindex="-1"><a class="header-anchor" href="#å•ä¾‹æ¨¡å¼å®ç°"><span>å•ä¾‹æ¨¡å¼å®ç°</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// åˆ›å»ºå…¨å±€å•ä¾‹å®ä¾‹ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªSSEè¿æ¥</span></span>
<span class="line"><span class="token keyword">let</span> sseServiceInstance <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">getSseService</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sseServiceInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    sseServiceInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSEService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> sseServiceInstance</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ ¸å¿ƒå±æ€§è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒå±æ€§è¯´æ˜"><span>æ ¸å¿ƒå±æ€§è¯´æ˜</span></a></h3><table><thead><tr><th>å±æ€§</th><th>ç±»å‹</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>eventSource</code></td><td>EventSource</td><td>åŸç”ŸSSEè¿æ¥å¯¹è±¡</td></tr><tr><td><code>listeners</code></td><td>Map</td><td>äº‹ä»¶ç›‘å¬å™¨é›†åˆ</td></tr><tr><td><code>referenceCount</code></td><td>number</td><td><strong>å¼•ç”¨è®¡æ•°æœºåˆ¶</strong>ï¼Œæ”¯æŒå¤šç»„ä»¶å…±äº«</td></tr><tr><td><code>isConnected</code>/<code>isConnecting</code></td><td>boolean</td><td>è¿æ¥çŠ¶æ€ç®¡ç†</td></tr></tbody></table><h2 id="ğŸ”„-æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶"><span>ğŸ”„ æ ¸å¿ƒåŠŸèƒ½æœºåˆ¶</span></a></h2><ol><li>å¼•ç”¨è®¡æ•°ç®¡ç†</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// è¿æ¥æ—¶å¢åŠ è®¡æ•°</span></span>
<span class="line"><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>referenceCount<span class="token operator">++</span></span>
<span class="line">  <span class="token comment">// åªæœ‰ç¬¬ä¸€ä¸ªå¼•ç”¨æ‰çœŸæ­£å»ºç«‹è¿æ¥</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ–­å¼€æ—¶å‡å°‘è®¡æ•°</span></span>
<span class="line"><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>referenceCount<span class="token operator">--</span></span>
<span class="line">  <span class="token comment">// åªæœ‰è®¡æ•°ä¸º0æ—¶æ‰çœŸæ­£æ–­å¼€è¿æ¥</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¼˜åŠ¿</strong>ï¼šå¤šä¸ªUIç»„ä»¶å¯ä»¥ç‹¬ç«‹ä½¿ç”¨SSEæœåŠ¡ï¼Œæ— éœ€æ‹…å¿ƒé‡å¤è¿æ¥æˆ–è¿‡æ—©æ–­å¼€ã€‚</p><ol start="2"><li>æ™ºèƒ½é‡è¿ç­–ç•¥</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æŒ‡æ•°é€€é¿ç®—æ³•ï¼šé‡è¿å»¶è¿Ÿéšå°è¯•æ¬¡æ•°å¢åŠ </span></span>
<span class="line">  <span class="token keyword">const</span> baseDelay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectInterval <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">    <span class="token number">30000</span> <span class="token comment">// æœ€å¤§å»¶è¿Ÿ30ç§’</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶ï¼ˆ5æ¬¡ï¼‰</li><li>é¿å…ç½‘ç»œæ‹¥å¡çš„é€€é¿ç­–ç•¥</li><li>è¿æ¥çŠ¶æ€æ£€æŸ¥é˜²æ­¢é‡å¤é‡è¿</li></ul><ol start="3"><li>å®Œæ•´çš„äº‹ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// äº‹ä»¶ç›‘å¬å™¨ç®¡ç†</span></span>
<span class="line"><span class="token function">on</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>    <span class="token comment">// æ³¨å†Œç›‘å¬</span></span>
<span class="line"><span class="token function">off</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>   <span class="token comment">// ç§»é™¤ç›‘å¬  </span></span>
<span class="line"><span class="token function">emit</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> data<span class="token punctuation">)</span>      <span class="token comment">// è§¦å‘äº‹ä»¶</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ”¯æŒçš„äº‹ä»¶ç±»å‹</span></span>
<span class="line"><span class="token string">&#39;device-registered&#39;</span>    <span class="token comment">// è®¾å¤‡æ³¨å†Œ</span></span>
<span class="line"><span class="token string">&#39;device-online&#39;</span>        <span class="token comment">// è®¾å¤‡ä¸Šçº¿  </span></span>
<span class="line"><span class="token string">&#39;device-offline&#39;</span>       <span class="token comment">// è®¾å¤‡ç¦»çº¿</span></span>
<span class="line"><span class="token string">&#39;device-alert&#39;</span>         <span class="token comment">// è®¾å¤‡å‘Šè­¦</span></span>
<span class="line"><span class="token string">&#39;statistics-update&#39;</span>    <span class="token comment">// ç»Ÿè®¡æ›´æ–°</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸŒ-è¿æ¥é…ç½®ä¸urlå¤„ç†" tabindex="-1"><a class="header-anchor" href="#ğŸŒ-è¿æ¥é…ç½®ä¸urlå¤„ç†"><span>ğŸŒ è¿æ¥é…ç½®ä¸URLå¤„ç†</span></a></h2><p>ç¯å¢ƒè‡ªé€‚åº”URLæ„å»º</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// å¼€å‘ç¯å¢ƒï¼šå®Œæ•´URL</span></span>
<span class="line"><span class="token comment">// ç”Ÿäº§ç¯å¢ƒï¼šç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡nginxä»£ç†ï¼‰</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>sseEndpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/device/notifications/sse</span><span class="token template-punctuation string">`</span></span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>sseEndpoint <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/device/notifications/sse</span><span class="token template-punctuation string">`</span></span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿æ¥è¶…æ—¶æ§åˆ¶</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> connectionTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnecting <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isConnected<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;SSEè¿æ¥è¶…æ—¶&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span> <span class="token comment">// 2åˆ†é’Ÿè¶…æ—¶ï¼Œé€‚åº”ç”Ÿäº§ç¯å¢ƒ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ›¡ï¸-å¥å£®æ€§è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ğŸ›¡ï¸-å¥å£®æ€§è®¾è®¡"><span>ğŸ›¡ï¸ å¥å£®æ€§è®¾è®¡</span></a></h2><p>é”™è¯¯å¤„ç†ä¸æ¢å¤</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line">eventSource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æ ¹æ®readyStateé‡‡å–ä¸åŒç­–ç•¥</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è¿æ¥å…³é—­æ—¶é‡è¿</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// CONNECTING/OPENçŠ¶æ€ä¸‹çš„é”™è¯¯æœ‰ä¸åŒå¤„ç†é€»è¾‘</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>èµ„æºæ¸…ç†æœºåˆ¶</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">setupPageUnloadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// é¡µé¢å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-ç›‘æ§ä¸è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-ç›‘æ§ä¸è¯Šæ–­"><span>ğŸ“Š ç›‘æ§ä¸è¯Šæ–­</span></a></h2><p>è¿æ¥çŠ¶æ€ç›‘æ§</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">startConnectionMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ¯30ç§’æ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventSource<span class="token punctuation">.</span>readyState <span class="token operator">===</span> EventSource<span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleReconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è‡ªåŠ¨æ¢å¤æ–­å¼€çš„è¿æ¥</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¦ç»†çš„æ—¥å¿—è®°å½•</p><p>ä»£ç ä¸­åŒ…å«å¤§é‡<code>console.log</code>è¯­å¥ï¼Œä¾¿äºï¼š</p><ul><li>è°ƒè¯•è¿æ¥é—®é¢˜</li><li>ç›‘æ§äº‹ä»¶æµ</li><li>è¯Šæ–­ç½‘ç»œå¼‚å¸¸</li></ul><h2 id="ğŸ¯-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-ä½¿ç”¨ç¤ºä¾‹"><span>ğŸ¯ ä½¿ç”¨ç¤ºä¾‹</span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨</span></span>
<span class="line"><span class="token keyword">import</span> sseService <span class="token keyword">from</span> <span class="token string">&#39;./sse-service&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç›‘å¬è®¾å¤‡ä¸Šçº¿äº‹ä»¶</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡ä¸Šçº¿:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment">// æ›´æ–°UIçŠ¶æ€</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å»ºç«‹è¿æ¥</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶å¸è½½æ—¶æ–­å¼€è¿æ¥</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ’¡-è®¾è®¡äº®ç‚¹" tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-è®¾è®¡äº®ç‚¹"><span>ğŸ’¡ è®¾è®¡äº®ç‚¹</span></a></h2><ol><li><strong>å•ä¸€èŒè´£</strong>ï¼šä¸“æ³¨SSEè¿æ¥ç®¡ç†ï¼Œä¸æºæ‚ä¸šåŠ¡é€»è¾‘</li><li><strong>å®¹é”™æ€§å¼º</strong>ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤æœºåˆ¶</li><li><strong>èµ„æºå‹å¥½</strong>ï¼šå¼•ç”¨è®¡æ•°é¿å…é‡å¤è¿æ¥ï¼ŒåŠæ—¶æ¸…ç†èµ„æº</li><li><strong>å¯æ‰©å±•</strong>ï¼šäº‹ä»¶æœºåˆ¶ä¾¿äºåŠŸèƒ½æ‰©å±•</li><li><strong>ç”Ÿäº§å°±ç»ª</strong>ï¼šè€ƒè™‘å¤šç§è¾¹ç¼˜æƒ…å†µå’Œç½‘ç»œç¯å¢ƒ</li></ol><h2 id="äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶"><span><strong>äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œæœºåˆ¶</strong></span></a></h2><p>ä»£ç è§£æ</p><p>ä»¥ä»¥ä¸‹ä»£ç ä¸ºä¾‹ï¼š</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"> <span class="token function">on</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>æ•°æ®ç»“æ„è§£æ</li></ol><p><code>this.listeners</code>æ˜¯ä»€ä¹ˆï¼Ÿ</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// listeners æ˜¯ä¸€ä¸ª Map æ•°æ®ç»“æ„ï¼Œå­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">  <span class="token comment">// é”®(key): äº‹ä»¶ç±»å‹(string)</span></span>
<span class="line">  <span class="token comment">// å€¼(value): å›è°ƒå‡½æ•°æ•°ç»„(Array&lt;Function&gt;)</span></span>
<span class="line">  </span>
<span class="line">  <span class="token punctuation">[</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback1<span class="token punctuation">,</span> callback2<span class="token punctuation">,</span> callback3<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback4<span class="token punctuation">,</span> callback5<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback6<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>ä»£ç æ‰§è¡Œæ­¥éª¤åˆ†è§£</li></ol><p>æ­¥éª¤1ï¼šæ£€æŸ¥äº‹ä»¶ç±»å‹æ˜¯å¦å·²å­˜åœ¨</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½œç”¨</strong>ï¼š</p><ul><li>æ£€æŸ¥ <code>this.listeners</code>Map ä¸­æ˜¯å¦å·²ç»æœ‰è¿™ä¸ª <code>eventType</code>çš„æ¡ç›®</li><li>å¦‚æœæ²¡æœ‰ï¼ˆå³ç¬¬ä¸€æ¬¡æ³¨å†Œè¯¥äº‹ä»¶ç±»å‹ï¼‰ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ä½œä¸ºå€¼</li><li>ç›¸å½“äºåˆå§‹åŒ–è¿™ä¸ªäº‹ä»¶ç±»å‹çš„ç›‘å¬å™¨åˆ—è¡¨</li></ul><p><strong>ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ç¬¬ä¸€æ¬¡æ³¨å†Œ &#39;device-online&#39; äº‹ä»¶</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">)</span> <span class="token comment">// false</span></span>
<span class="line"><span class="token comment">// æ‰§è¡Œåï¼šåˆ›å»ºç©ºæ•°ç»„</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// ç°åœ¨ï¼šlisteners = Map { &#39;device-online&#39; =&gt; [] }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¥éª¤2ï¼šæ·»åŠ å›è°ƒå‡½æ•°åˆ°å¯¹åº”æ•°ç»„</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>ä½œç”¨</strong>ï¼š</p><p>getæŸ¥æ‰¾åˆ°å…¶åœ¨å­—å…¸ä¸­çš„å­—æ®µï¼Œpushå°†å‡½æ•°æ·»åŠ åˆ°è¯¥å­—æ®µå¯¹åº”çš„å€¼ä¸Š</p><ul><li>é€šè¿‡ <code>eventType</code>è·å–å¯¹åº”çš„å›è°ƒå‡½æ•°æ•°ç»„</li><li>å°†æ–°çš„ <code>callback</code>å‡½æ•°æ·»åŠ åˆ°æ•°ç»„æœ«å°¾</li></ul><p><strong>ç¤ºä¾‹</strong>ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// æ³¨å†Œç¬¬ä¸€ä¸ªç›‘å¬å™¨</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> callback1<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// listeners = Map { &#39;device-online&#39; =&gt; [callback1] }</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ³¨å†Œç¬¬äºŒä¸ªç›‘å¬å™¨ï¼ˆåŒä¸€äº‹ä»¶ç±»å‹ï¼‰</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> callback2<span class="token punctuation">)</span>  </span>
<span class="line"><span class="token comment">// listeners = Map { &#39;device-online&#39; =&gt; [callback1, callback2] }</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>å®é™…ä½¿ç”¨ç¤ºä¾‹</li></ol><p>åœºæ™¯ï¼šå¤šä¸ªç»„ä»¶ç›‘å¬åŒä¸€äº‹ä»¶</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ç»„ä»¶A - è®¾å¤‡åˆ—è¡¨</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»„ä»¶A: è®¾å¤‡ä¸Šçº¿&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// æ›´æ–°è®¾å¤‡åˆ—è¡¨çš„UIæ˜¾ç¤º</span></span>
<span class="line">    <span class="token function">updateDeviceStatus</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token string">&#39;online&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶B - ç»Ÿè®¡é¢æ¿  </span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»„ä»¶B: è®¾å¤‡ä¸Šçº¿&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// æ›´æ–°åœ¨çº¿è®¾å¤‡è®¡æ•°</span></span>
<span class="line">    onlineCount<span class="token punctuation">.</span>value<span class="token operator">++</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶C - å®æ—¶é€šçŸ¥</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ç»„ä»¶C: è®¾å¤‡ä¸Šçº¿&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥</span></span>
<span class="line">    <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">è®¾å¤‡ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>deviceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> å·²ä¸Šçº¿</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å½“è®¾å¤‡ä¸Šçº¿äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰€æœ‰3ä¸ªå›è°ƒå‡½æ•°éƒ½ä¼šæ‰§è¡Œ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> Map <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&#39;device-online&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ç»„ä»¶Açš„å›è°ƒ */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ç»„ä»¶Bçš„å›è°ƒ */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ç»„ä»¶Cçš„å›è°ƒ */</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;device-offline&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token comment">// å…¶ä»–äº‹ä»¶çš„å›è°ƒå‡½æ•°...</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>ä¸ <code>emit</code>æ–¹æ³•çš„é…åˆ</li></ol><p>äº‹ä»¶è§¦å‘æµç¨‹ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// å½“æ”¶åˆ°SSEæ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨emitè§¦å‘äº‹ä»¶</span></span>
<span class="line"><span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è·å–è¯¥äº‹ä»¶ç±»å‹çš„æ‰€æœ‰å›è°ƒå‡½æ•°</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment">// ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå›è°ƒå‡½æ•°</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œé”™è¯¯:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä½¿ç”¨ç¤ºä¾‹ï¼š</span></span>
<span class="line"><span class="token comment">// æ”¶åˆ°åç«¯æ¨é€ï¼šæ‰§è¡Œ emit(&#39;device-online&#39;, deviceData)</span></span>
<span class="line"><span class="token comment">// ç»“æœï¼šç»„ä»¶Aã€Bã€Cçš„å›è°ƒå‡½æ•°éƒ½ä¼šæ”¶åˆ°deviceDataå¹¶æ‰§è¡Œ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>è®¾è®¡æ¨¡å¼çš„ä¼˜åŠ¿</li></ol><p>è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰</p><p>è¿™ç§è®¾è®¡å®ç°äº†ç»å…¸çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ä¸»é¢˜ï¼ˆSubjectï¼‰ - SSEæœåŠ¡</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">SSEService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// è§‚å¯Ÿè€…åˆ—è¡¨</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ³¨å†Œè§‚å¯Ÿè€…</span></span>
<span class="line">    <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ... ä¸Šé¢çš„å®ç°</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é€šçŸ¥è§‚å¯Ÿè€…</span></span>
<span class="line">    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ... è§¦å‘æ‰€æœ‰å›è°ƒ</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è§‚å¯Ÿè€…ï¼ˆObserversï¼‰ - å„ä¸ªç»„ä»¶</span></span>
<span class="line">componentA<span class="token punctuation">.</span><span class="token function-variable function">onDeviceOnline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* å¤„ç†é€»è¾‘ */</span> <span class="token punctuation">}</span></span>
<span class="line">componentB<span class="token punctuation">.</span><span class="token function-variable function">onDeviceOnline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* å¤„ç†é€»è¾‘ */</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ³¨å†Œè§‚å¯Ÿè€…</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> componentA<span class="token punctuation">.</span>onDeviceOnline<span class="token punctuation">)</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> componentB<span class="token punctuation">.</span>onDeviceOnline<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>å®é™…ä¸šåŠ¡åœºæ™¯</li></ol><p>æ¨¡å—åŒ–çš„äº‹ä»¶å¤„ç†</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// è®¾å¤‡ç®¡ç†æ¨¡å—</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">DeviceManager</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceOnline</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceOffline</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceAlert</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">handleDeviceOnline</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä¸“é—¨çš„è®¾å¤‡ä¸Šçº¿å¤„ç†é€»è¾‘</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDeviceCache</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token string">&#39;online&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refreshDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ... å…¶ä»–å¤„ç†æ–¹æ³•</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å‘Šè­¦ç®¡ç†æ¨¡å—  </span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AlertManager</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">setupEventHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleNewAlert</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleDeviceRecovery</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">handleNewAlert</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä¸“é—¨çš„å‘Šè­¦å¤„ç†é€»è¾‘</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">storeAlert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyUsers</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ... å…¶ä»–å¤„ç†æ–¹æ³•</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>æ€»ç»“</li></ol><p>è¿™ä¸ª <code>on</code>æ–¹æ³•çš„æ ¸å¿ƒä½œç”¨ï¼š</p><ol><li><strong>äº‹ä»¶æ³¨å†Œ</strong>ï¼šå…è®¸ä¸åŒçš„ä»£ç æ¨¡å—æ³¨å†Œå¯¹ç‰¹å®šäº‹ä»¶çš„å…´è¶£</li><li><strong>å¤šç›‘å¬å™¨æ”¯æŒ</strong>ï¼šåŒä¸€äº‹ä»¶ç±»å‹å¯ä»¥æ³¨å†Œå¤šä¸ªå›è°ƒå‡½æ•°</li><li><strong>è§£è€¦è®¾è®¡</strong>ï¼šäº‹ä»¶æºï¼ˆSSEæœåŠ¡ï¼‰å’Œäº‹ä»¶å¤„ç†é€»è¾‘ï¼ˆå„ä¸ªç»„ä»¶ï¼‰å®Œå…¨è§£è€¦</li><li><strong>çµæ´»æ‰©å±•</strong>ï¼šå¯ä»¥åŠ¨æ€æ·»åŠ /ç§»é™¤äº‹ä»¶ç›‘å¬å™¨</li></ol><p>è¿™ç§è®¾è®¡è®©SSEæœåŠ¡æˆä¸ºäº†ä¸€ä¸ª<strong>äº‹ä»¶æ€»çº¿</strong>ï¼Œå„ä¸ªä¸šåŠ¡æ¨¡å—åªéœ€è¦å…³å¿ƒè‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œè€Œä¸éœ€è¦çŸ¥é“å…¶ä»–æ¨¡å—çš„å­˜åœ¨ï¼Œå¤§å¤§æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p><h2 id="sseæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#sseæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£"><span>SSEæœåŠ¡äº‹ä»¶ç›‘å¬å™¨è¯¦è§£</span></a></h2><h3 id="ğŸ¯-äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†"><span>ğŸ¯ äº‹ä»¶ç›‘å¬å™¨è®¾è®¡åŸç†</span></a></h3><p>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>Map</code>å­˜å‚¨ç›‘å¬å™¨ï¼Ÿ</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>è®¾è®¡åŸå› ï¼š</strong></p><ol><li><strong>äº‹ä»¶ç±»å‹ä½œä¸ºé”®</strong> - æ¯ä¸ªäº‹ä»¶ç±»å‹(<code>device-online</code>, <code>device-offline</code>ç­‰)å¯¹åº”ä¸€ä¸ªå›è°ƒå‡½æ•°æ•°ç»„</li><li><strong>æ”¯æŒå¤šä¸ªç›‘å¬å™¨</strong> - åŒä¸€äº‹ä»¶å¯ä»¥æœ‰å¤šä¸ªå¤„ç†å‡½æ•°</li><li><strong>å¿«é€ŸæŸ¥æ‰¾</strong> - Mapçš„é”®æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦O(1)</li><li><strong>å†…å­˜ç®¡ç†</strong> - ä¾¿äºç²¾ç¡®æ·»åŠ /ç§»é™¤ç›‘å¬å™¨</li></ol><blockquote><p>listeners æ˜¯ä¸€ä¸ª Map æ•°æ®ç»“æ„ï¼Œå­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</p><p>this.listeners = new Map([</p><p><em>// é”®(key): äº‹ä»¶ç±»å‹(string)</em></p><p><em>// å€¼(value): å›è°ƒå‡½æ•°æ•°ç»„(Array&lt;å‡½æ•°&gt;)</em></p><p>[&#39;device-online&#39;, [callback1, callback2, callback3]],</p><p>[&#39;device-offline&#39;, [callback4, callback5]],</p><p>[&#39;device-alert&#39;, [callback6]],</p><p><em>// ...</em></p><p>])</p></blockquote><h3 id="ğŸ”§-äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ"><span>ğŸ”§ äº‹ä»¶ç³»ç»Ÿå®ç°è§£æ</span></a></h3><h4 id="_1-ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_1-ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶"><span>1. ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// é¦–æ¬¡æ³¨å†Œæ—¶åˆ›å»ºæ•°ç»„</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>  <span class="token comment">// æ·»åŠ å›è°ƒåˆ°æ•°ç»„</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼š</strong></p><ul><li><strong>åŠ¨æ€æ‰©å±•</strong> - ä¸éœ€è¦é¢„å…ˆå®šä¹‰æ‰€æœ‰äº‹ä»¶ç±»å‹</li><li><strong>æ‰¹é‡å¤„ç†</strong> - åŒä¸€äº‹ä»¶çš„æ‰€æœ‰å›è°ƒå­˜å‚¨åœ¨æ•°ç»„ä¸­</li><li><strong>æœ‰åºæ‰§è¡Œ</strong> - å›è°ƒæŒ‰æ·»åŠ é¡ºåºæ‰§è¡Œ</li></ul><h4 id="_2-äº‹ä»¶è§¦å‘æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-äº‹ä»¶è§¦å‘æœºåˆ¶"><span>2. äº‹ä»¶è§¦å‘æœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment">// æ‰§è¡Œæ¯ä¸ªå›è°ƒå‡½æ•°</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œé”™è¯¯ [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eventType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å…³é”®è®¾è®¡ç‚¹ï¼š</strong></p><ul><li><strong>é”™è¯¯éš”ç¦»</strong> - å•ä¸ªå›è°ƒé”™è¯¯ä¸å½±å“å…¶ä»–å›è°ƒ</li><li><strong>æ•°æ®ä¼ é€’</strong> - ç»Ÿä¸€çš„æ•°æ®æ ¼å¼ä¼ é€’</li><li><strong>ç©ºå®‰å…¨</strong> - æ£€æŸ¥äº‹ä»¶ç±»å‹æ˜¯å¦å­˜åœ¨</li></ul><h4 id="_3-ç›‘å¬å™¨ç§»é™¤æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-ç›‘å¬å™¨ç§»é™¤æœºåˆ¶"><span>3. ç›‘å¬å™¨ç§»é™¤æœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">off</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> index <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      callbacks<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// ç²¾ç¡®ç§»é™¤æŒ‡å®šå›è°ƒ</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è®¾è®¡ä¼˜åŠ¿ï¼š</strong></p><ul><li><strong>ç²¾ç¡®æ§åˆ¶</strong> - å¯ä»¥ç§»é™¤ç‰¹å®šçš„å›è°ƒå‡½æ•°</li><li><strong>å†…å­˜å‹å¥½</strong> - é¿å…å†…å­˜æ³„æ¼</li><li><strong>çµæ´»ç®¡ç†</strong> - æ”¯æŒä¸´æ—¶ç›‘å¬å’Œæ°¸ä¹…ç›‘å¬</li></ul><h3 id="ğŸª-å®é™…è°ƒç”¨æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#ğŸª-å®é™…è°ƒç”¨æ–¹å¼"><span>ğŸª å®é™…è°ƒç”¨æ–¹å¼</span></a></h3><h4 id="åœ¨vueç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#åœ¨vueç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹"><span>åœ¨Vueç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// åœ¨Vueç»„ä»¶ä¸­</span></span>
<span class="line"><span class="token keyword">import</span> sseService <span class="token keyword">from</span> <span class="token string">&#39;./sseService&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ - è¿™æ‰æ˜¯æ­£ç¡®çš„è°ƒç”¨æ–¹å¼ï¼</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOnline<span class="token punctuation">)</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOffline<span class="token punctuation">)</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceAlert<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿æ¥SSEæœåŠ¡</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è®¾å¤‡ä¸Šçº¿å¤„ç†å‡½æ•°</span></span>
<span class="line">    <span class="token function">handleDeviceOnline</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡ä¸Šçº¿:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&#39;UPDATE_DEVICE_STATUS&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">deviceId</span><span class="token operator">:</span> data<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;online&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾å¤‡ç¦»çº¿å¤„ç†å‡½æ•°  </span></span>
<span class="line">    <span class="token function">handleDeviceOffline</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡ç¦»çº¿:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">è®¾å¤‡ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>deviceName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> å·²ç¦»çº¿</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾å¤‡å‘Šè­¦å¤„ç†å‡½æ•°</span></span>
<span class="line">    <span class="token function">handleDeviceAlert</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è®¾å¤‡å‘Šè­¦:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">triggerAlarmSound</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">displayAlertPopup</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token function">beforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ç»„ä»¶é”€æ¯æ—¶ç§»é™¤ç›‘å¬å™¨ - é‡è¦ï¼</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOnline<span class="token punctuation">)</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceOffline<span class="token punctuation">)</span> </span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleDeviceAlert<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ–­å¼€SSEè¿æ¥</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºä»€ä¹ˆè¿™æ ·è°ƒç”¨" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆè¿™æ ·è°ƒç”¨"><span>ä¸ºä»€ä¹ˆè¿™æ ·è°ƒç”¨ï¼Ÿ</span></a></h4><p><strong>1. åˆ†ç¦»å…³æ³¨ç‚¹</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// âŒ é”™è¯¯æ–¹å¼ï¼šåœ¨SSEæœåŠ¡ä¸­ç¡¬ç¼–ç ä¸šåŠ¡é€»è¾‘</span></span>
<span class="line">eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// è¿™é‡Œç›´æ¥å†™UIæ›´æ–°é€»è¾‘ï¼Œè€¦åˆåº¦é«˜</span></span>
<span class="line">  <span class="token function">updateUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">sendNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">playSound</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// âœ… æ­£ç¡®æ–¹å¼ï¼šSSEæœåŠ¡åªè´Ÿè´£äº‹ä»¶åˆ†å‘</span></span>
<span class="line">eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token comment">// çº¯æ•°æ®ä¼ é€’ï¼Œæ— ä¸šåŠ¡é€»è¾‘</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. æ”¯æŒå¤šç»„ä»¶ç›‘å¬</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ç»„ä»¶A - è®¾å¤‡ç®¡ç†é¡µé¢</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refreshDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// åˆ·æ–°è®¾å¤‡åˆ—è¡¨</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶B - å‘Šè­¦ä¸­å¿ƒ  </span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateStatistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„ä»¶C - å®æ—¶ç›‘æ§å¤§å±</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDashboard</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// æ›´æ–°ç›‘æ§é¢æ¿</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ‰€æœ‰ç»„ä»¶éƒ½ä¼šæ”¶åˆ°åŒä¸€ä¸ªäº‹ä»¶ï¼Œå„è‡ªå¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. åŠ¨æ€äº‹ä»¶ç®¡ç†</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// ä¸´æ—¶ç›‘å¬ - åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹ç›‘å¬</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">tempHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>severity <span class="token operator">===</span> <span class="token string">&#39;high&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleCriticalAlert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// å¤„ç†å®Œåç§»é™¤ç›‘å¬å™¨</span></span>
<span class="line">    sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> tempHandler<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-alert&#39;</span><span class="token punctuation">,</span> tempHandler<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ¡ä»¶æ€§ç›‘å¬</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userRole <span class="token operator">===</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;statistics-update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleAdminStats<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ”„-äº‹ä»¶è§¦å‘æµç¨‹" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-äº‹ä»¶è§¦å‘æµç¨‹"><span>ğŸ”„ äº‹ä»¶è§¦å‘æµç¨‹</span></a></h3><h4 id="å®Œæ•´çš„äº‹ä»¶æµè½¬" tabindex="-1"><a class="header-anchor" href="#å®Œæ•´çš„äº‹ä»¶æµè½¬"><span>å®Œæ•´çš„äº‹ä»¶æµè½¬</span></a></h4><div class="language-markdown line-numbers-mode" data-highlighter="prismjs" data-ext="md"><pre><code><span class="line">æœåŠ¡å™¨å‘é€äº‹ä»¶ </span>
<span class="line">    â†“</span>
<span class="line">EventSourceæ¥æ”¶åˆ°åŸå§‹äº‹ä»¶</span>
<span class="line">    â†“  </span>
<span class="line">è§£æäº‹ä»¶æ•°æ® JSON.parse(event.data)</span>
<span class="line">    â†“</span>
<span class="line">è°ƒç”¨ emit(&#39;event-type&#39;, parsedData)</span>
<span class="line">    â†“</span>
<span class="line">æŸ¥æ‰¾Mapä¸­å¯¹åº”äº‹ä»¶ç±»å‹çš„æ‰€æœ‰å›è°ƒå‡½æ•°</span>
<span class="line">    â†“  </span>
<span class="line">æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªå›è°ƒå‡½æ•°</span>
<span class="line">    â†“</span>
<span class="line">å„ç»„ä»¶å¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é”™è¯¯å¤„ç†æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#é”™è¯¯å¤„ç†æœºåˆ¶"><span>é”™è¯¯å¤„ç†æœºåˆ¶</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// æ‰§è¡Œå›è°ƒ</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å…³é”®ï¼šå•ä¸ªå›è°ƒé”™è¯¯ä¸å½±å“å…¶ä»–å›è°ƒ</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œé”™è¯¯ [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eventType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// å¯ä»¥æ·»åŠ é”™è¯¯ä¸ŠæŠ¥é€»è¾‘</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> eventType<span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ’¡-è®¾è®¡ä¼˜åŠ¿æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ’¡-è®¾è®¡ä¼˜åŠ¿æ€»ç»“"><span>ğŸ’¡ è®¾è®¡ä¼˜åŠ¿æ€»ç»“</span></a></h3><ol><li><strong>è§£è€¦æ€§å¼º</strong> - SSEæœåŠ¡ä¸å…³å¿ƒå…·ä½“ä¸šåŠ¡é€»è¾‘</li><li><strong>æ‰©å±•æ€§å¥½</strong> - æ–°ç»„ä»¶å¯ä»¥è½»æ¾æ·»åŠ ç›‘å¬</li><li><strong>ç»´æŠ¤æ€§é«˜</strong> - äº‹ä»¶å¤„ç†é€»è¾‘åˆ†æ•£åœ¨å„ç»„ä»¶</li><li><strong>é”™è¯¯éš”ç¦»</strong> - å•ä¸ªç›‘å¬å™¨é”™è¯¯ä¸å½±å“æ•´ä½“</li><li><strong>å†…å­˜å®‰å…¨</strong> - æ”¯æŒç²¾ç¡®çš„ç›‘å¬å™¨ç®¡ç†</li></ol><p>è¿™ç§è®¾è®¡è®©SSEæœåŠ¡æˆä¸ºä¸€ä¸ªçº¯ç²¹çš„<strong>äº‹ä»¶ä¸­è½¬ç«™</strong>ï¼Œä¸šåŠ¡ç»„ä»¶æŒ‰éœ€è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå®ç°äº†å®Œç¾çš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">æœ€è¿‘æ›´æ–°ï¼š: </span><time class="meta-item-info" datetime="2025-12-09T09:10:11.000Z" data-allow-mismatch>2025/12/9 17:10</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wh8261408@126.com">ksldnasx</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><div class="social-share-global"><!----><button class="social-share-btn social-share-trigger" type="button" role="button" aria-label="Toggle global social share"><span class="social-share-icon-svg"><svg viewBox="0 0 1040 1024" xmlns="http://www.w3.org/2000/svg">
  <path d="M823.506 631.474c0-7.192-3.783-12.397-11.352-15.71-6.816-2.838-13.154-1.419-18.925 4.352-9.37 8.612-19.116 15.33-29.24 19.968-6.529 3.594-9.745 8.801-9.745 15.71V771.53c0 23.753-8.516 44.195-25.455 61.132-16.938 16.936-37.283 25.455-61.132 25.455H217.765c-23.753 0-44.195-8.517-61.131-25.455-16.937-16.939-25.455-37.284-25.455-61.132V321.639c0-23.753 8.516-44.195 25.455-61.132s37.283-25.455 61.131-25.455h60.565c2.175 0 5.016-.757 8.612-2.174 20.156-12.304 44.195-23.091 71.921-32.459 9.37-1.799 14.1-7.57 14.1-17.317 0-4.734-1.703-8.708-5.108-12.208-3.407-3.407-7.476-5.108-12.208-5.108h-137.88c-42.87 0-79.588 15.235-110.06 45.707S62 278.683 62 321.553V771.54c0 42.87 15.234 79.588 45.707 110.06s67.19 45.707 110.06 45.707H667.66c42.87 0 79.589-15.234 110.06-45.707 30.472-30.473 45.708-67.19 45.708-110.06l.095-140.06-.016-.006zm138.454-292.52c0-9.369-3.408-17.506-10.315-24.32L744.016 107.005c-6.815-6.815-14.953-10.315-24.32-10.315-4.353 0-8.802.945-13.535 2.745-14.1 6.15-21.106 16.75-21.106 31.891v103.812h-86.497c-38.235 0-73.625 1.986-106.273 5.962-32.648 3.976-61.42 9.465-86.215 16.468-24.887 7.004-47.315 15.805-67.282 26.214-19.967 10.41-37 21.576-51.104 33.217-14.103 11.64-26.403 25.077-37 40.03-10.598 14.953-19.117 29.62-25.456 44.097-6.34 14.387-11.352 30.285-15.142 47.604-3.783 17.317-6.341 33.5-7.571 48.64-1.229 15.143-1.893 31.514-1.893 49.212 0 20.157 3.125 42.208 9.465 65.959 6.34 23.753 13.25 44.384 20.818 61.608 7.571 17.317 16.468 35.207 26.784 53.848 10.315 18.55 17.413 30.945 21.387 37.001 3.977 6.15 7.76 11.736 11.353 16.75 3.595 4.733 8.327 7.004 14.1 7.004 1.42 0 3.595-.381 6.529-1.042 8.327-3.977 11.925-10.126 10.787-18.358-16.184-121.134-2.838-206.4 40.03-255.797 41.452-47.222 120.376-70.88 236.868-70.88h86.497v103.81c0 15.143 7.004 25.742 21.106 31.892 4.734 1.799 9.18 2.745 13.534 2.745 9.745 0 17.887-3.408 24.321-10.316L951.83 363.178c6.716-6.815 10.126-14.858 10.126-24.227l.004.004z" />
</svg></span></button></div><!--]--><!--]--></div>
    <script type="module" src="/vuepress_blog/assets/app-UmXydJji.js" defer></script>
  </body>
</html>
