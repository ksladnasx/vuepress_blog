<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" defer></script><title>SSE最大连接次数突破 | xh's blog </title><meta name="description" content="A VuePress bolg Site for personal useage">
    <link rel="preload" href="/vuepress_blog/assets/style-DHqMCh0M.css" as="style"><link rel="stylesheet" href="/vuepress_blog/assets/style-DHqMCh0M.css">
    <link rel="modulepreload" href="/vuepress_blog/assets/app-UmXydJji.js"><link rel="modulepreload" href="/vuepress_blog/assets/BroadcastChannel方式解决sse连接数限制.html-6GwTFg2t.js">
    <link rel="prefetch" href="/vuepress_blog/assets/get-started.html-BrW2OPcu.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-S6-rR0CJ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/初级大模型算法工程师入门入门规划.html-PUD1hSiK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/操作系统.html-YNNKIn6e.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/操作系统例题讲解.html-B-6_ekdl.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/操作系统课后题目.html-DlApKp0k.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/操作系统重难点.html-M5l9okRE.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/网络协议分析.html-B0mjkNCX.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/网络协议分析题.html-yvjyltqR.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/网络安全.html-fOPBAX77.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/网络安全重点.html-DGVv5IzC.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/软件定义网络.html-C67XijOI.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/软件定义网络重点.html-6Z3iflPr.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/软件定义网络题.html-BU6JilnL.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SSEDemoFronted.html-CkMTwiLD.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/sseDomeServer.html-CMTtiZ0q.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/sseService.html-DLsLrZ5r.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/sseServiceWithBroadcastChannel.html-92dTtKay.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/docker部署流程.html-DqTH97bC.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/全栈开发.html-VUAWgHhY.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/项目经验.html-DUtouFrA.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/实习周总结1.html-DaCt6wvi.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/实习周总结2.html-BY7LBVJh.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/实习周总结3.html-C5mwoDrK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/实习周总结4.html-CBxQOGEn.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/实习周总结5.html-DCgmTcP6.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/实习经验.html-Dkk6S6Zk.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/前端面试八股文.html-DQw4HnpF.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/基础算法.html-CLOvrdrI.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/倒货经验总结.html-CL4iQ_7G.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/todolist建立.html-B5EjdCgT.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/硅谷甄选项目笔记.html-DqHEbjP1.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/docsify项目创建与部署.html-CpLorkJ_.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/插件公式示例.html-B33CRABu.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/算法刷题.html-CXEaZEAR.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/组件传值与代码规范.html-DaePJcxq.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/nuxt.html-BVl7vC9r.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Nuxt4.html-De03BzNK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/react入门.html-DfLkVr-w.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/react小实践.html-DOHkAIiK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/农担项目所遇问题及总结.html-DyTzNiLQ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Http.html-BpCPFPFy.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Nginx.html-DwHWNYWU.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/element-plus.html-Dt0Shoe-.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/vitest.html-BbKkgsi4.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Vuepress上手.html-DYIwU6Ih.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/Vue探索.html-qlFs5-z_.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/BroadcastChannel版本sse解读.html-Adx7YZ9b.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/sseService文件解析.html-CFu3fdr4.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SSE实践测试.html-CjSzpvRb.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SSE简介.html-D_5DeskR.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/流的处理.html-tw-jDSu6.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/404.html-472gSdLs.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-D4Vr1x4U.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-D8BmJRWK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DtbrREu1.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CgGRLfzl.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-NnkC358F.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C3eHk0Vo.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-HpkemBGh.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BX-QMr8T.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C3D2GhaK.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BPrdVcRz.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CCEYsNkj.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-B2JiFNeM.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Bt2CbkVn.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DzDHRR9E.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Clc2oEJx.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-cvbG_VKD.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-jmKdmd-f.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Bw9losca.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-COZGe3TG.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-Bo82Xr6G.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DUExu0Mr.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DlomL8bU.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DbNnBFIB.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BYZrx3C-.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-lH_oohfr.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CM3W7KJs.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BTsj8QAg.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C9z1iF9P.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BLMxlOAl.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-BAbqhVZZ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-B3MMSr5C.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DI57HGoX.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DjiCImKB.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-C3CBBVRX.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-DoDaI2dM.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-zq0tpgC6.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-B_2lmY7-.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-RbGocMDB.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CdlxNR7n.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-D7Fl-7bv.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CoM2O_F8.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CU0fp3Et.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-CYcDJCeV.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/index.html-_3AD9UeM.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/SearchResult-Dq26a1PS.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/browser-B92KtQ1J.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/social-share-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/vuepress_blog/assets/giscus-DrGxERkK.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/vuepress_blog/"><!----><span class="vp-site-name vp-hide-mobile" aria-hidden="true">xh&#39;s blog </span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/article/" aria-label="文章"><!--[--><!--[--><!--]--><!--]-->文章<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/category/" aria-label="分类"><!--[--><!--[--><!--]--><!--]-->分类<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/tag/" aria-label="标签"><!--[--><!--[--><!--]--><!--]-->标签<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--><!--]-->时间线<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="slimsearch-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">搜索</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/article/" aria-label="文章"><!--[--><!--[--><!--]--><!--]-->文章<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/category/" aria-label="分类"><!--[--><!--[--><!--]--><!--]-->分类<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/tag/" aria-label="标签"><!--[--><!--[--><!--]--><!--]-->标签<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/vuepress_blog/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--><!--]-->时间线<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">SSE最大连接次数突破 <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="sse最大连接次数突破" tabindex="-1"><a class="header-anchor" href="#sse最大连接次数突破"><span>SSE最大连接次数突破</span></a></h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>在我们建立sse连接的时候，由于<strong>HTTP/1.1</strong>的限制，在该协议下，大多数现代浏览器（如Chrome、Firefox、Edge）对<strong>同一域名（协议+域名+端口）的并发连接数限制通常为6个</strong>。这意味着，同一个浏览器标签页（或同一浏览器实例）中，对相同域名最多只能同时建立约6个SSE连接，超出此数量的新连接会被浏览器阻塞，直到有连接被关闭。</p><p>若需要突破此限制，可考虑以下方案：</p><table><thead><tr><th style="text-align:left;">解决方案</th><th style="text-align:left;">描述</th><th style="text-align:left;">适用场景</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>升级至HTTP/2</strong></td><td style="text-align:left;">HTTP/2支持<strong>多路复用</strong>，可在单个TCP连接上并行处理多个请求和响应，从而从根本上解决连接数限制问题。</td><td style="text-align:left;"><strong>长远和推荐方案</strong>，需服务器和浏览器支持，通常要求使用HTTPS。</td></tr><tr><td style="text-align:left;"><strong>多域名/多端口策略</strong></td><td style="text-align:left;">将SSE连接分散到不同的子域（如<code>sse1.example.com</code>, <code>sse2.example.com</code>）或不同端口号。每个子域或端口享有独立的6个连接限额。</td><td style="text-align:left;"><strong>过渡方案</strong>，适用于暂无法升级HTTP/2的情况，但配置管理稍复杂。</td></tr><tr><td style="text-align:left;"><strong>优化连接使用</strong></td><td style="text-align:left;">利用标签页切换及时关闭不再需要的SSE连接，或尝试将多个数据流合并到一个SSE连接中传输（通过不同事件类型区分）。</td><td style="text-align:left;"><strong>基础优化</strong>，良好的连接管理习惯。</td></tr></tbody></table><p>但是以上方法都存在一定缺陷，HTTP/2存在兼容性问题，多端口策略过于繁琐，动态切换策略又过于消耗资源。</p><p>然后自然想到的就是<strong>SharedWorker</strong>，他可以将多个标签页共享一个SSE连接，且 <strong>SharedWorker</strong>自动管理连接生命周期，但是存在的问题是后期调试特别复杂，同时其相当于一个中间层，会对业务代码进行改动，较为复杂。</p><p>最后根据学长的建议选择了<strong>BroadcastChannel</strong> 的主从模式这种解决方式，它在保证较为轻量级且兼容性更好的情况下，基本上避免了业务逻辑部分的代码的修改，只需要对SSE连接的代码的主体文件进行修改。</p><p><strong>BroadcastChannel</strong> 的主从模式类似一个频道，对于每个打开的标签页进行选举，选举好主标签页后主标签页建立SSE连接，同时对各类服务器更新的事件，利用<strong>BroadcastChannel</strong>进行广播，从标签页在收到广播后触发本地的处理器并更新数据。其核心就是让多个标签页共享一个SSE连接，避免连接数超限。</p><h3 id="核心思想" tabindex="-1"><a class="header-anchor" href="#核心思想"><span><strong>核心思想</strong></span></a></h3><ol><li><strong>只有一个&quot;主&quot;标签页</strong>真正建立SSE连接</li><li><strong>其他&quot;从&quot;标签页</strong>通过消息通道接收事件</li><li><strong>自动选举和故障转移</strong>确保高可用性</li></ol><p><img src="/vuepress_blog/assets/BroadcastChannel-C0PR7yXL.png" alt="BroadcastChannel主从模式消息传递演示"></p><h2 id="原理机制详解" tabindex="-1"><a class="header-anchor" href="#原理机制详解"><span>原理机制详解</span></a></h2><h3 id="_1-通信基础-broadcastchannel" tabindex="-1"><a class="header-anchor" href="#_1-通信基础-broadcastchannel"><span>1. 通信基础：BroadcastChannel</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 所有标签页创建相同的频道</span></span>
<span class="line"><span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">&#39;sse-connection&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 发送消息（所有同源标签页都能收到）</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">&#39;消息内容&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 接收消息</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;收到消息:&#39;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-主从选举机制" tabindex="-1"><a class="header-anchor" href="#_2-主从选举机制"><span>2. 主从选举机制</span></a></h3><p><strong>目标</strong>：在多个标签页中选出唯一的&quot;主&quot;</p><p><strong>选举流程</strong>：</p><ol><li><strong>宣布参选</strong>：每个标签页启动时都宣布自己要参与选举</li><li><strong>收集候选</strong>：等待一段时间收集所有参选的标签页</li><li><strong>确定主节点</strong>：按特定规则（如ID最小）选出主标签页</li><li><strong>公布结果</strong>：将选举结果广播给所有标签页</li></ol><h3 id="_3-消息广播机制" tabindex="-1"><a class="header-anchor" href="#_3-消息广播机制"><span>3. 消息广播机制</span></a></h3><p><strong>主标签页职责</strong>：</p><ul><li>建立唯一真实的SSE连接</li><li>接收服务器推送的事件</li><li>将事件广播给所有从标签页</li></ul><p><strong>从标签页职责</strong>：</p><ul><li>监听主标签页的广播消息</li><li>触发本地的事件处理器</li></ul><p><img src="/vuepress_blog/assets/BroadcastChannel-C0PR7yXL.png" alt="BroadcastChannel主从模式消息传递演示"></p><h3 id="_4-故障转移机制" tabindex="-1"><a class="header-anchor" href="#_4-故障转移机制"><span>4. 故障转移机制</span></a></h3><p><strong>心跳检测</strong>：</p><ul><li>主标签页定期发送心跳信号</li><li>从标签页监控心跳，发现超时则重新选举</li></ul><p><strong>主标签页异常处理</strong>：</p><ul><li>页面关闭前尝试转移控制权</li><li>崩溃时自动触发重新选举</li></ul><h2 id="需要改其他业务逻辑代码吗" tabindex="-1"><a class="header-anchor" href="#需要改其他业务逻辑代码吗"><span>需要改其他业务逻辑代码吗？</span></a></h2><p>并不需要，其他页面使用 <code>sseService</code> 的方式可以保持不变，主从模式的逻辑是在 <code>SSEService</code> 内部实现的，对外部使用层是透明的。</p><h3 id="具体使用方式-与之前兼容" tabindex="-1"><a class="header-anchor" href="#具体使用方式-与之前兼容"><span>具体使用方式（与之前兼容）</span></a></h3><p>你仍然可以通过以下方式在页面中使用 SSE 服务，无需关心当前是主标签页还是从标签页：</p><ol><li><strong>引入服务</strong>：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">import</span> sseService <span class="token keyword">from</span> <span class="token string">&#39;@/path/to/sseService.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li><strong>监听事件</strong>（如设备上线、离线等）：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 监听设备上线事件</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-online&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;设备上线:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 处理业务逻辑（如更新UI、提示用户等）</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 监听连接状态事件</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connected&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;SSE连接成功:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 监听错误事件</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;SSE错误:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>建立连接</strong>：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 调用connect()即可，内部会自动判断是否为主标签页（主标签页实际建立连接，从标签页通过BroadcastChannel接收事件）</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;连接请求已处理&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;连接处理失败:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>断开连接</strong>：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 调用disconnect()，内部会根据引用计数和主从状态判断是否实际断开连接</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li><strong>移除事件监听</strong>（避免内存泄漏）：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">handleDeviceOffline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;设备离线:&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 添加监听</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> handleDeviceOffline<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 页面卸载或不需要时移除</span></span>
<span class="line">sseService<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;device-offline&#39;</span><span class="token punctuation">,</span> handleDeviceOffline<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="核心原因" tabindex="-1"><a class="header-anchor" href="#核心原因"><span>核心原因</span></a></h3><p>主从模式通过 <code>BroadcastChannel</code> 和 <code>localStorage</code> 实现的是<strong>内部连接管理逻辑</strong>，对外暴露的 <code>on</code>/<code>off</code>/<code>connect</code>/<code>disconnect</code> 等接口并未改变。无论是主标签页（实际建立 SSE 连接）还是从标签页（通过广播接收事件），都会通过 <code>emit</code> 方法触发你注册的事件回调，因此业务层无需做任何调整。</p><h2 id="核心设计" tabindex="-1"><a class="header-anchor" href="#核心设计"><span>核心设计</span></a></h2><p>该代码实现了一个基于 Server-Sent Events (SSE) 的服务，核心设计围绕<strong>主从标签页模式</strong>展开，通过解决多标签页连接限制、确保连接稳定性、同步状态等问题，实现了高效的实时消息推送。以下是几个核心设计的详细说明：</p><h3 id="_1-主从标签页模式-突破-sse-连接限制" tabindex="-1"><a class="header-anchor" href="#_1-主从标签页模式-突破-sse-连接限制"><span>1. 主从标签页模式（突破 SSE 连接限制）</span></a></h3><p>浏览器对同一域名的并发连接数有限制（通常为 6 个），若多个标签页同时建立 SSE 连接，可能导致连接失败或阻塞。因此，代码设计了 “主从模式”：</p><ul><li><strong>主标签页</strong>：唯一与后端建立 SSE 连接的标签页，负责接收实时消息并广播给所有从标签页。</li><li><strong>从标签页</strong>：不直接连接 SSE，通过<code>BroadcastChannel</code>接收主标签页转发的消息。</li></ul><p><strong>核心实现</strong>：</p><ul><li>通过<code>electionMaster()</code>方法选举主标签页：按标签页 ID（<code>tab-1</code>、<code>tab-2</code>...）排序，ID 最小的标签页当选为主标签页。</li><li>主标签页通过<code>localStorage</code>存储自身标识（<code>masterKey</code>），并通过<code>BroadcastChannel</code>广播 “主标签页宣告”（<code>master-announcement</code>），同步状态给所有从标签页。</li><li>从标签页监听<code>localStorage</code>变化和广播消息，确认主标签页身份，避免重复连接。</li></ul><h3 id="_2-主标签页心跳检测-确保主标签页存活" tabindex="-1"><a class="header-anchor" href="#_2-主标签页心跳检测-确保主标签页存活"><span>2. 主标签页心跳检测（确保主标签页存活）</span></a></h3><p>为防止主标签页崩溃、关闭或失去响应后导致整个 SSE 服务中断，设计了心跳检测机制：</p><ul><li><strong>从标签页发起心跳检查</strong>：从标签页每 30 秒通过<code>BroadcastChannel</code>发送<code>ping</code>消息给主标签页。</li><li><strong>主标签页响应心跳</strong>：主标签页收到<code>ping</code>后，立即返回<code>pong</code>消息。</li><li><strong>超时处理</strong>：从标签页发送<code>ping</code>后设置 5 秒超时器（<code>refreshTimeout</code>），若未收到<code>pong</code>，判定主标签页失效，触发重新选举（<code>electionMaster()</code>）。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 从标签页定期发送ping并检测超时</span></span>
<span class="line"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;ping&quot;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>refreshTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;主标签页心跳超时，触发重新选举&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">electionMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5秒超时</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每30秒检查一次</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 主标签页响应pong</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;ping&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-标签页状态监控-管理活跃标签页生命周期" tabindex="-1"><a class="header-anchor" href="#_3-标签页状态监控-管理活跃标签页生命周期"><span>3. 标签页状态监控（管理活跃标签页生命周期）</span></a></h3><p>为准确维护标签页列表、及时清理无效标签页，设计了标签页状态监控机制：</p><ul><li><strong>活跃标签页注册与注销</strong>： <ul><li>标签页初始化时通过<code>registerActiveTab()</code>将自身添加到<code>localStorage</code>的活跃列表（<code>activeTabsKey</code>），包含<code>tabId</code>、<code>instanceId</code>（唯一标识，避免刷新冲突）和时间戳。</li><li>标签页关闭 / 刷新时通过<code>unregisterActiveTab()</code>从活跃列表移除自身，并在列表为空时重置计数器和主标签页标识。</li></ul></li><li><strong>过期标签页清理</strong>：通过<code>cleanExpiredTabs()</code>定期清理 5 分钟内未更新时间戳的标签页（视为已关闭或失效），确保活跃列表准确。</li><li><strong>活跃状态更新</strong>：每 60 秒通过定时器更新当前标签页的时间戳，标记为 “活跃”，避免被误判为过期。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 定期更新当前标签页时间戳（保持活跃）</span></span>
<span class="line"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> activeTabs <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeTabsKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;[]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> tabIndex <span class="token operator">=</span> activeTabs<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">tab</span> <span class="token operator">=&gt;</span> tab<span class="token punctuation">.</span>instanceId <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tabInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>tabIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    activeTabs<span class="token punctuation">[</span>tabIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新时间戳</span></span>
<span class="line">    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeTabsKey<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>activeTabs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每分钟更新一次</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-连接管理与重连机制-确保-sse-连接稳定" tabindex="-1"><a class="header-anchor" href="#_4-连接管理与重连机制-确保-sse-连接稳定"><span>4. 连接管理与重连机制（确保 SSE 连接稳定）</span></a></h3><p>主标签页负责维护与后端的 SSE 连接，通过重连机制处理网络波动或连接失败：</p><ul><li><strong>连接状态标识</strong>：通过<code>isConnected</code>（是否连接）、<code>isConnecting</code>（是否正在连接）跟踪状态，避免重复连接。</li><li>重连策略： <ul><li>连接失败时触发<code>handleReconnect()</code>，采用<strong>指数退避策略</strong>（重连间隔从 3 秒开始，每次翻倍，最大 30 秒）。</li><li>限制最大重连次数（默认 5 次），超过后停止重连并触发<code>max-reconnect-reached</code>事件。</li></ul></li><li><strong>引用计数</strong>：通过<code>referenceCount</code>跟踪对 SSE 服务的引用（如组件使用），仅当计数为 0 时才真正断开连接，避免频繁连接 / 断开。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 指数退避重连</span></span>
<span class="line"><span class="token keyword">const</span> baseDelay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectInterval <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reconnectAttempts <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token number">30000</span> <span class="token comment">// 最大延迟30秒</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> baseDelay<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-跨标签页消息同步-基于-broadcastchannel" tabindex="-1"><a class="header-anchor" href="#_5-跨标签页消息同步-基于-broadcastchannel"><span>5. 跨标签页消息同步（基于 BroadcastChannel）</span></a></h3><p>通过<code>BroadcastChannel</code>实现主从标签页的消息同步：</p><ul><li>主标签页接收 SSE 消息后，通过<code>broadcastSSEMessage()</code>将消息广播给所有从标签页（如<code>device-online</code>、<code>device-offline</code>等事件）。</li><li>从标签页监听广播消息，触发本地事件回调，实现与主标签页的状态同步。</li></ul><p><strong>核心代码</strong>：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 主标签页广播消息</span></span>
<span class="line"><span class="token function">broadcastSSEMessage</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;sse-message&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> eventType<span class="token punctuation">,</span> payload <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 从标签页接收消息并触发事件</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>broadcastChannel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;sse-message&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>eventType<span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h3><p>该代码通过<strong>主从模式</strong>解决多标签页连接限制，通过<strong>心跳检测</strong>确保主标签页有效性，通过<strong>状态监控</strong>管理标签页生命周期，通过<strong>重连机制</strong>保证连接稳定性，最终实现了高效、可靠的跨标签页 SSE 实时消息推送服务。</p><h2 id="源代码" tabindex="-1"><a class="header-anchor" href="#源代码"><span>源代码</span></a></h2><p>此处我为原有的SSE连接文件（<code>sseService.js</code>）添加BroadcastChannel 的主从模式逻辑以突破SSE的连接限制，选择主标签页的规则是先到先得，所有标签页都关闭的时候清除选举的标签页标志，也就是 <strong>Localstorage</strong> 里的标志。当然在撰写代码的同时也要注意主标签页如果被用户叉掉或者刷新，被刷新的标签页的id会进行重置，则要进行重新选举。</p><p>源代码：<a class="route-link" href="/vuepress_blog/posts/codes/sseServiceWithBroadcastChannel.html">sseServiceWithBroadcastChannel.js</a></p><p>相关文章：<a class="route-link" href="/vuepress_blog/posts/sse/BroadcastChannel%E7%89%88%E6%9C%ACsse%E8%A7%A3%E8%AF%BB.html">BroadcastChannel版本sse文件解读.md</a></p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新：: </span><time class="meta-item-info" datetime="2025-12-09T09:10:11.000Z" data-allow-mismatch>2025/12/9 17:10</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wh8261408@126.com">ksldnasx</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><div class="social-share-global"><!----><button class="social-share-btn social-share-trigger" type="button" role="button" aria-label="Toggle global social share"><span class="social-share-icon-svg"><svg viewBox="0 0 1040 1024" xmlns="http://www.w3.org/2000/svg">
  <path d="M823.506 631.474c0-7.192-3.783-12.397-11.352-15.71-6.816-2.838-13.154-1.419-18.925 4.352-9.37 8.612-19.116 15.33-29.24 19.968-6.529 3.594-9.745 8.801-9.745 15.71V771.53c0 23.753-8.516 44.195-25.455 61.132-16.938 16.936-37.283 25.455-61.132 25.455H217.765c-23.753 0-44.195-8.517-61.131-25.455-16.937-16.939-25.455-37.284-25.455-61.132V321.639c0-23.753 8.516-44.195 25.455-61.132s37.283-25.455 61.131-25.455h60.565c2.175 0 5.016-.757 8.612-2.174 20.156-12.304 44.195-23.091 71.921-32.459 9.37-1.799 14.1-7.57 14.1-17.317 0-4.734-1.703-8.708-5.108-12.208-3.407-3.407-7.476-5.108-12.208-5.108h-137.88c-42.87 0-79.588 15.235-110.06 45.707S62 278.683 62 321.553V771.54c0 42.87 15.234 79.588 45.707 110.06s67.19 45.707 110.06 45.707H667.66c42.87 0 79.589-15.234 110.06-45.707 30.472-30.473 45.708-67.19 45.708-110.06l.095-140.06-.016-.006zm138.454-292.52c0-9.369-3.408-17.506-10.315-24.32L744.016 107.005c-6.815-6.815-14.953-10.315-24.32-10.315-4.353 0-8.802.945-13.535 2.745-14.1 6.15-21.106 16.75-21.106 31.891v103.812h-86.497c-38.235 0-73.625 1.986-106.273 5.962-32.648 3.976-61.42 9.465-86.215 16.468-24.887 7.004-47.315 15.805-67.282 26.214-19.967 10.41-37 21.576-51.104 33.217-14.103 11.64-26.403 25.077-37 40.03-10.598 14.953-19.117 29.62-25.456 44.097-6.34 14.387-11.352 30.285-15.142 47.604-3.783 17.317-6.341 33.5-7.571 48.64-1.229 15.143-1.893 31.514-1.893 49.212 0 20.157 3.125 42.208 9.465 65.959 6.34 23.753 13.25 44.384 20.818 61.608 7.571 17.317 16.468 35.207 26.784 53.848 10.315 18.55 17.413 30.945 21.387 37.001 3.977 6.15 7.76 11.736 11.353 16.75 3.595 4.733 8.327 7.004 14.1 7.004 1.42 0 3.595-.381 6.529-1.042 8.327-3.977 11.925-10.126 10.787-18.358-16.184-121.134-2.838-206.4 40.03-255.797 41.452-47.222 120.376-70.88 236.868-70.88h86.497v103.81c0 15.143 7.004 25.742 21.106 31.892 4.734 1.799 9.18 2.745 13.534 2.745 9.745 0 17.887-3.408 24.321-10.316L951.83 363.178c6.716-6.815 10.126-14.858 10.126-24.227l.004.004z" />
</svg></span></button></div><!--]--><!--]--></div>
    <script type="module" src="/vuepress_blog/assets/app-UmXydJji.js" defer></script>
  </body>
</html>
